<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khizr Assistant</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

:root {
--primary: #8B5CF6;
--secondary: #EF4444;
--bg: #0A0A0B;
--bg-card: #111115;
--text-primary: #E4E4E7;
--text-secondary: #71717A;
--text-accent: #A855F7;
--border: #27272A;
--border-accent: #3F3F46;
--success: #10B981;
--warning: #F59E0B;
}

.theme-red {
--primary: #EF4444;
--text-accent: #F87171;
}

.theme-purple {
--primary: #8B5CF6;
--text-accent: #A855F7;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'JetBrains Mono', monospace;
background: var(--bg);
color: var(--text-primary);
line-height: 1.6;
font-weight: 400;
min-height: 100vh;
font-size: 14px;
}

.container {
max-width: 900px;
margin: 0 auto;
padding: 40px 20px;
}

/* Header */
.header {
display: flex;
justify-content: flex-end;
align-items: center;
margin-bottom: 60px;
padding-bottom: 20px;
}

.theme-toggle {
display: flex;
gap: 8px;
align-items: center;
}

.theme-btn {
width: 12px;
height: 12px;
border-radius: 2px;
border: none;
cursor: pointer;
transition: all 0.2s ease;
opacity: 0.6;
}

.theme-btn.purple { background: #8B5CF6; }
.theme-btn.red { background: #EF4444; }

.theme-btn:hover {
opacity: 1;
transform: scale(1.1);
}

.theme-btn.active {
opacity: 1;
}

.logout-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 16px;
padding: 4px;
border-radius: 4px;
transition: all 0.2s ease;
margin-left: 16px;
}

.logout-btn:hover {
color: var(--primary);
background: rgba(139, 92, 246, 0.1);
}

/* Navigation */
.nav {
display: flex;
gap: 30px;
margin-bottom: 40px;
font-size: 13px;
font-weight: 500;
}

.nav-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
transition: color 0.2s ease;
position: relative;
padding: 0;
font-family: inherit;
font-size: inherit;
}

.nav-btn:hover {
color: var(--text-primary);
}

.nav-btn.active {
color: var(--primary);
}

.nav-btn.active::after {
content: '';
position: absolute;
bottom: -8px;
left: 0;
width: 100%;
height: 1px;
background: var(--primary);
}

/* Main Layout */
.today-view {
display: grid;
grid-template-columns: 1.5fr 1fr;
gap: 60px;
}

/* Cards */
.code-card {
padding: 0;
margin-bottom: 48px;
font-size: 13px;
}

.code-card.boxed {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
padding: 24px;
}

.section-header {
color: var(--text-accent);
font-size: 12px;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}

.add-btn {
background: var(--primary);
border: none;
border-radius: 3px;
padding: 4px 8px;
color: white;
cursor: pointer;
font-size: 10px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.add-btn:hover {
opacity: 0.9;
}

/* Tasks */
.task-list {
list-style: none;
}

.task-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 0;
transition: all 0.2s ease;
cursor: pointer;
}

.task-item:hover {
color: var(--primary);
padding-left: 12px;
}

.task-item.urgent {
border-left: 2px solid var(--secondary);
padding-left: 8px;
}

.task-item.urgent:hover {
padding-left: 16px;
}

.task-title {
font-weight: 400;
flex: 1;
}

.task-priority {
font-size: 10px;
padding: 2px 6px;
border-radius: 3px;
margin-right: 8px;
font-weight: 500;
}

.task-priority.urgent {
background: var(--secondary);
color: white;
}

.task-priority.research {
background: var(--primary);
color: white;
}

.task-actions {
display: flex;
gap: 4px;
opacity: 0;
transition: opacity 0.2s ease;
}

.task-item:hover .task-actions {
opacity: 1;
}

.task-action-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 12px;
padding: 2px;
border-radius: 2px;
transition: all 0.2s ease;
}

.task-action-btn:hover {
color: var(--primary);
background: rgba(139, 92, 246, 0.1);
}

/* Date Display */
.date-display {
font-size: 16px;
font-weight: 500;
color: var(--text-primary);
text-transform: capitalize;
}

/* Time Events */
.time-list {
list-style: none;
}

.time-item {
display: flex;
align-items: center;
padding: 6px 0;
font-family: inherit;
}

.time {
color: var(--primary);
font-weight: 500;
min-width: 80px;
font-size: 12px;
}

.time-separator {
color: var(--text-secondary);
margin: 0 16px;
font-weight: 300;
}

.event-title {
color: var(--text-primary);
font-weight: 400;
}

/* AI Input */
.ai-input-container {
position: relative;
}

.ai-prompt {
color: var(--text-accent);
font-size: 12px;
margin-bottom: 12px;
font-weight: 500;
}

.ai-textarea {
width: 100%;
background: transparent;
border: none;
padding: 0;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
resize: none;
height: 100px;
transition: border-color 0.2s ease;
}

.ai-textarea:focus {
outline: none;
}

.ai-textarea::placeholder {
color: var(--text-secondary);
font-style: italic;
}

.ai-send-btn {
position: absolute;
bottom: 0;
right: 0;
background: var(--primary);
border: none;
border-radius: 3px;
padding: 6px 12px;
color: white;
cursor: pointer;
font-size: 11px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.ai-send-btn:hover {
opacity: 0.9;
transform: scale(0.98);
}

/* Mind Button */
.mind-btn {
background: transparent;
border: none;
padding: 0;
color: var(--primary);
cursor: pointer;
font-size: 13px;
font-family: inherit;
font-weight: 500;
width: 100%;
transition: all 0.2s ease;
text-align: left;
}

.mind-btn:hover {
color: var(--text-primary);
}

/* Views */
.project-view, .mind-view, .bigpage-view, .emails-view, .goals-view, .insights-view {
display: none;
}

.project-view.active, .mind-view.active, .bigpage-view.active, .emails-view.active, .goals-view.active, .insights-view.active {
display: block;
}

/* Project Items */
.project-item {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
padding: 16px;
margin-bottom: 12px;
cursor: pointer;
transition: all 0.2s ease;
}

.project-item:hover {
border-color: var(--primary);
background: rgba(139, 92, 246, 0.04);
}

.project-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 4px;
}

.project-desc {
color: var(--text-secondary);
font-size: 12px;
}

/* Mind Textarea */
.mind-textarea {
width: 100%;
min-height: 120px;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 16px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
resize: vertical;
transition: border-color 0.2s ease;
}

.mind-textarea:focus {
outline: none;
border-color: var(--primary);
}

.mind-textarea::placeholder {
color: var(--text-secondary);
font-style: italic;
}

.mind-save-btn {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
margin-top: 12px;
transition: all 0.2s ease;
}

.mind-save-btn:hover {
opacity: 0.9;
}

/* Chat Interface (Big Page) */
.chat-container {
display: flex;
flex-direction: column;
height: 500px;
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
}

.chat-messages {
flex: 1;
padding: 20px;
overflow-y: auto;
display: flex;
flex-direction: column;
gap: 16px;
}

.chat-message {
display: flex;
flex-direction: column;
max-width: 80%;
}

.chat-message.user {
align-self: flex-end;
}

.chat-message.assistant {
align-self: flex-start;
}

.message-content {
padding: 12px 16px;
border-radius: 8px;
font-size: 13px;
}

.chat-message.user .message-content {
background: var(--primary);
color: white;
}

.chat-message.assistant .message-content {
background: rgba(139, 92, 246, 0.1);
border: 1px solid var(--border);
color: var(--text-primary);
}

.message-time {
font-size: 10px;
color: var(--text-secondary);
margin-top: 4px;
padding: 0 4px;
}

.chat-input-container {
padding: 16px;
border-top: 1px solid var(--border);
display: flex;
gap: 8px;
}

.chat-input {
flex: 1;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 12px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
}

.chat-input:focus {
outline: none;
border-color: var(--primary);
}

.chat-send-btn {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.chat-send-btn:hover {
opacity: 0.9;
}

.chat-send-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Email List */
.email-item {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 4px;
padding: 12px;
margin-bottom: 8px;
cursor: pointer;
transition: all 0.2s ease;
}

.email-item:hover {
border-color: var(--primary);
background: rgba(139, 92, 246, 0.04);
}

.email-item.unread {
border-left: 3px solid var(--primary);
}

.email-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 4px;
}

.email-from {
font-weight: 500;
color: var(--text-primary);
font-size: 12px;
}

.email-date {
font-size: 10px;
color: var(--text-secondary);
}

.email-subject {
font-size: 13px;
color: var(--text-primary);
margin-bottom: 4px;
}

.email-snippet {
font-size: 11px;
color: var(--text-secondary);
line-height: 1.4;
}

/* Forms and Modals */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
}

.modal {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 8px;
padding: 24px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
}

.modal-close {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 16px;
padding: 4px;
}

.modal-close:hover {
color: var(--primary);
}

.form-group {
margin-bottom: 16px;
}

.form-label {
display: block;
font-size: 12px;
font-weight: 500;
color: var(--text-accent);
margin-bottom: 6px;
}

.form-input, .form-textarea {
width: 100%;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 12px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
}

.form-textarea {
resize: vertical;
min-height: 80px;
}

.form-input:focus, .form-textarea:focus {
outline: none;
border-color: var(--primary);
}

.form-buttons {
display: flex;
gap: 8px;
justify-content: flex-end;
margin-top: 20px;
}

.btn-secondary {
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 16px;
color: var(--text-secondary);
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.btn-secondary:hover {
border-color: var(--primary);
color: var(--primary);
}

.btn-primary {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.btn-primary:hover {
opacity: 0.9;
}

/* Responsive */
@media (max-width: 768px) {
.container {
padding: 20px 16px;
}

.today-view {
grid-template-columns: 1fr;
gap: 32px;
}

.nav {
gap: 20px;
margin-bottom: 32px;
}

.header {
margin-bottom: 40px;
}

.chat-container {
height: 400px;
}

.modal {
width: 95%;
padding: 20px;
}
}
</style>
</head>
<body class="theme-purple">

<div class="container">
<!-- Header -->
<header class="header">
<div class="theme-toggle">
<button class="theme-btn purple active" onclick="setTheme('purple')"></button>
<button class="theme-btn red" onclick="setTheme('red')"></button>
</div>
<button class="logout-btn" onclick="logout()" title="Logout">üö™</button>
</header>

<!-- Navigation -->
<nav class="nav">
<button class="nav-btn active" onclick="showView('today')">today</button>
<button class="nav-btn" onclick="showView('projects')">projects</button>
<button class="nav-btn" onclick="showView('goals')">goals</button>
<button class="nav-btn" onclick="showView('insights')">insights</button>
<button class="nav-btn" onclick="showView('chat')">ai chat</button>
<button class="nav-btn" onclick="showView('emails')">emails</button>
</nav>

<!-- Today View -->
<div id="today-view" class="today-view">
<div class="main-content">
<!-- Date Display -->
<div class="code-card">
<div class="section-header">today</div>
<div class="date-display" id="dateDisplay"></div>
</div>

<!-- Dynamic Tasks -->
<div class="code-card" id="tasksContainer">
<div class="section-header">
tasks
<button class="add-btn" onclick="showAddTaskModal()">+ add</button>
</div>
<ul class="task-list" id="tasksList">
<li class="task-item">
<span class="task-title">sell bidu</span>
<div class="task-actions">
<button class="task-action-btn" onclick="archiveTask(1)" title="Archive">üìÅ</button>
<button class="task-action-btn" onclick="addToCalendar(1)" title="Add to Calendar">üìÖ</button>
<button class="task-action-btn" onclick="deleteTask(1)" title="Delete">üóëÔ∏è</button>
</div>
</li>
<li class="task-item">
<span class="task-title">review quarterly plan</span>
<div class="task-actions">
<button class="task-action-btn" onclick="archiveTask(2)" title="Archive">üìÅ</button>
<button class="task-action-btn" onclick="addToCalendar(2)" title="Add to Calendar">üìÖ</button>
<button class="task-action-btn" onclick="deleteTask(2)" title="Delete">üóëÔ∏è</button>
</div>
</li>
<li class="task-item">
<span class="task-title">call mom</span>
<div class="task-actions">
<button class="task-action-btn" onclick="archiveTask(3)" title="Archive">üìÅ</button>
<button class="task-action-btn" onclick="addToCalendar(3)" title="Add to Calendar">üìÖ</button>
<button class="task-action-btn" onclick="deleteTask(3)" title="Delete">üóëÔ∏è</button>
</div>
</li>
</ul>
</div>

<!-- AI Input -->
<div class="code-card">
<div class="section-header">process</div>
<div class="ai-input-container">
<div class="ai-prompt">tell me what's on your mind</div>
<textarea
class="ai-textarea"
placeholder="need to prep for client meeting, also buy groceries..."
id="aiNote"
></textarea>
<button class="ai-send-btn" onclick="processAINote()">run</button>
</div>
</div>
</div>

<div class="sidebar">
<!-- Time-bound Events -->
<div class="code-card">
<div class="section-header">timebound</div>
<ul class="time-list">
<li class="time-item">
<span class="time">1:00 PM</span>
<span class="time-separator">-</span>
<span class="event-title">meeting with neil</span>
</li>
<li class="time-item">
<span class="time">2:00 PM</span>
<span class="time-separator">-</span>
<span class="event-title">party</span>
</li>
<li class="time-item">
<span class="time">6:00 PM</span>
<span class="time-separator">-</span>
<span class="event-title">gym session</span>
</li>
</ul>
</div>

<!-- On My Mind -->
<button class="mind-btn" onclick="showMindPage()">
 on my mind
</button>
</div>
</div>

<!-- Project View -->
<div id="project-view" class="project-view">
<div class="code-card boxed">
<div class="section-header">
projects
<button class="add-btn" onclick="showAddProjectModal()">+ add</button>
</div>
<div class="project-list" id="projectList">
<div class="project-item" onclick="openProject('website-redesign')">
<div class="project-title">website redesign</div>
<div class="project-desc">3/5 tasks completed ‚Ä¢ Due next week</div>
</div>
<div class="project-item" onclick="openProject('health-goals')">
<div class="project-title">health goals</div>
<div class="project-desc">1/3 tasks completed ‚Ä¢ Ongoing</div>
</div>
<div class="project-item" onclick="openProject('learn-react')">
<div class="project-title">learn react</div>
<div class="project-desc">2/8 tasks completed ‚Ä¢ 2 months left</div>
</div>
</div>
</div>
</div>

<div id="goals-view" class="goals-view">
<div class="code-card boxed">
<div class="section-header">goals</div>
<p>Goals tracking coming soon...</p>
</div>
</div>

<div id="insights-view" class="insights-view">
<div class="code-card boxed">
<div class="section-header">insights</div>
<p>AI insights coming soon...</p>
</div>
</div>

<div id="mind-view" class="mind-view">
<div class="code-card boxed">
<div class="section-header">on my mind</div>
<textarea
id="mindInput"
class="mind-textarea"
placeholder="Share your thoughts, ideas, concerns..."
></textarea>
<button class="mind-save-btn" onclick="saveMindNote()">save thought</button>
</div>
</div>

<!-- AI Chat View (renamed from bigpage) -->
<div id="chat-view" class="bigpage-view">
<div class="code-card boxed">
<div class="section-header">ai chat</div>
<div class="chat-container">
<div class="chat-messages" id="chatMessages">
<div class="chat-message assistant">
<div class="message-content">
Hey! I'm your AI assistant. You can ask me anything or dump your thoughts here using our prefix system:
<br><br>
<strong>?</strong> research questions ‚Ä¢ <strong>zz</strong> tasks ‚Ä¢ <strong>og</strong> preserve notes ‚Ä¢ <strong>!!</strong> urgent items
<br><br>
What's on your mind?
</div>
<div class="message-time">Just now</div>
</div>
</div>
<div class="chat-input-container">
<input 
type="text" 
class="chat-input" 
id="chatInput" 
placeholder="Type your message or use prefixes: ? zz og !!"
onkeypress="handleChatKeyPress(event)"
>
<button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
</div>
</div>
</div>
</div>

<!-- Email View -->
<div id="emails-view" class="emails-view">
<div class="code-card boxed">
<div class="section-header">emails</div>
<div class="emails-controls" style="margin-bottom: 20px;">
<button class="btn-primary" onclick="connectGmail()" id="gmailConnectBtn">
Connect Gmail
</button>
<button class="btn-secondary" onclick="refreshEmails()" id="refreshEmailsBtn" style="display:none;">
Refresh
</button>
<span id="emailStatus" style="margin-left: 12px; font-size: 11px; color: var(--text-secondary);"></span>
</div>
<div class="emails-list" id="emailsList">
<p>Click "Connect Gmail" to start managing your emails...</p>
</div>
</div>
</div>

</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal-overlay" style="display: none;">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Add New Task</h3>
<button class="modal-close" onclick="closeModal('addTaskModal')">√ó</button>
</div>
<form onsubmit="submitTask(event)">
<div class="form-group">
<label class="form-label">Task Title</label>
<input type="text" class="form-input" id="taskTitle" required>
</div>
<div class="form-group">
<label class="form-label">Priority</label>
<select class="form-input" id="taskPriority">
<option value="normal">Normal</option>
<option value="urgent">Urgent</option>
<option value="low">Low</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Description (optional)</label>
<textarea class="form-textarea" id="taskDescription" placeholder="Additional details..."></textarea>
</div>
<div class="form-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
<button type="submit" class="btn-primary">Add Task</button>
</div>
</form>
</div>
</div>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal-overlay" style="display: none;">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Add New Project</h3>
<button class="modal-close" onclick="closeModal('addProjectModal')">√ó</button>
</div>
<form onsubmit="submitProject(event)">
<div class="form-group">
<label class="form-label">Project Name</label>
<input type="text" class="form-input" id="projectName" required>
</div>
<div class="form-group">
<label class="form-label">Description</label>
<textarea class="form-textarea" id="projectDescription" placeholder="What is this project about?"></textarea>
</div>
<div class="form-group">
<label class="form-label">Due Date (optional)</label>
<input type="date" class="form-input" id="projectDueDate">
</div>
<div class="form-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('addProjectModal')">Cancel</button>
<button type="submit" class="btn-primary">Add Project</button>
</div>
</form>
</div>
</div>

<script>
const API_URL = "https://khizr-assistant-api.onrender.com";

// Global state
let processedTasks = [];
let processedProjects = [];
let chatHistory = [];
let gmailConnected = false;
let emails = [];

// Theme switching
function setTheme(theme) {
document.body.className = `theme-${theme}`;
document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
const active = document.querySelector(`.theme-btn.${theme}`);
if (active) active.classList.add('active');
localStorage.setItem('theme', theme);
}

// View switching
function showView(viewName) {
document.querySelectorAll('[id$="-view"]').forEach(view => {
view.style.display = 'none';
view.classList.remove('active');
});

if (viewName === 'today') {
document.getElementById('today-view').style.display = 'grid';
} else if (viewName === 'chat') {
document.getElementById('chat-view').style.display = 'block';
document.getElementById('chat-view').classList.add('active');
} else {
const viewElement = document.getElementById(`${viewName}-view`);
if (viewElement) {
viewElement.style.display = 'block';
viewElement.classList.add('active');
}
}

document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
document.querySelectorAll('.nav-btn').forEach(btn => {
if (btn.textContent.toLowerCase().includes(viewName.toLowerCase()) || 
    (viewName === 'chat' && btn.textContent.toLowerCase().includes('chat'))) {
btn.classList.add('active');
}
});
}

// Chat functionality
function sendChatMessage() {
const input = document.getElementById('chatInput');
const message = input.value.trim();
if (!message) return;

// Add user message to chat
addChatMessage('user', message);
input.value = '';

const sendBtn = document.getElementById('chatSendBtn');
sendBtn.disabled = true;
sendBtn.textContent = 'Thinking...';

// Process the message
setTimeout(() => {
const response = processUserMessage(message);
addChatMessage('assistant', response);
sendBtn.disabled = false;
sendBtn.textContent = 'Send';
}, 1000 + Math.random() * 1000);
}

function handleChatKeyPress(event) {
if (event.key === 'Enter' && !event.shiftKey) {
event.preventDefault();
sendChatMessage();
}
}

function addChatMessage(sender, content) {
const messagesContainer = document.getElementById('chatMessages');
const messageDiv = document.createElement('div');
messageDiv.className = `chat-message ${sender}`;

const now = new Date();
const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

messageDiv.innerHTML = `
<div class="message-content">${content}</div>
<div class="message-time">${timeString}</div>
`;

messagesContainer.appendChild(messageDiv);
messagesContainer.scrollTop = messagesContainer.scrollHeight;

// Store in history
chatHistory.push({
sender,
content,
timestamp: now
});
}

function processUserMessage(message) {
// Check for prefix commands
if (message.startsWith('?')) {
const question = message.substring(1).trim();
processedTasks.push({
id: `research_${Date.now()}`,
title: `Research: ${question}`,
priority: 'research',
type: 'research',
created: new Date()
});
updateDashboard();
return `I've added "${question}" to your research queue. I'll analyze this and provide insights soon.`;
}

if (message.toLowerCase().startsWith('zz')) {
const task = message.substring(2).trim();
processedTasks.push({
id: `task_${Date.now()}`,
title: task,
priority: 'normal',
created: new Date()
});
updateDashboard();
return `Task created: "${task}". You can find it on your today dashboard.`;
}

if (message.startsWith('!!')) {
const urgentTask = message.substring(2).trim();
processedTasks.push({
id: `urgent_${Date.now()}`,
title: urgentTask,
priority: 'urgent',
created: new Date()
});
updateDashboard();
return `üî• Urgent task created: "${urgentTask}". This has been prioritized on your dashboard.`;
}

if (message.toLowerCase().startsWith('og')) {
const note = message.substring(2).trim();
// Store in notes/mind
const mindInput = document.getElementById('mindInput');
const currentMind = mindInput.value;
mindInput.value = currentMind ? `${currentMind}\n\n${note}` : note;
return `Note preserved: "${note}". I've added it to your "On My Mind" section.`;
}

// Regular conversation
const responses = [
`I understand you're thinking about: "${message}". Would you like me to break this down into actionable tasks or research items?`,
`Interesting! "${message}" - should I create any tasks or research items from this?`,
`Got it. "${message}" - I can help you organize this. Use prefixes like "zz" for tasks or "?" for research questions.`,
`Thanks for sharing that. If you want me to process "${message}" into actionable items, try using our prefix system.`,
`I see you're considering "${message}". Let me know if you'd like this turned into specific tasks or research topics.`
];

return responses[Math.floor(Math.random() * responses.length)];
}

// Gmail Integration
async function connectGmail() {
const connectBtn = document.getElementById('gmailConnectBtn');
const refreshBtn = document.getElementById('refreshEmailsBtn');
const status = document.getElementById('emailStatus');

connectBtn.disabled = true;
connectBtn.textContent = 'Connecting...';
status.textContent = 'Authenticating with Gmail...';

try {
const response = await fetch(`${API_URL}/gmail/connect`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
}
});

if (response.ok) {
const data = await response.json();
gmailConnected = true;
connectBtn.style.display = 'none';
refreshBtn.style.display = 'inline-block';
status.textContent = 'Connected to Gmail ‚úì';
await loadEmails();
} else {
throw new Error('Failed to connect');
}
} catch (error) {
status.textContent = 'Connection failed. Please try again.';
connectBtn.disabled = false;
connectBtn.textContent = 'Connect Gmail';
}
}

async function loadEmails() {
const status = document.getElementById('emailStatus');
status.textContent = 'Loading emails...';

try {
const response = await fetch(`${API_URL}/gmail/messages`, {
method: 'GET',
headers: {
'Content-Type': 'application/json'
}
});

if (response.ok) {
const data = await response.json();
emails = data.messages || [];
displayEmails();
status.textContent = `Loaded ${emails.length} emails`;
} else {
throw new Error('Failed to load emails');
}
} catch (error) {
status.textContent = 'Failed to load emails';
console.error('Email loading error:', error);
}
}

async function refreshEmails() {
if (!gmailConnected) return;
await loadEmails();
}

function displayEmails() {
const emailsList = document.getElementById('emailsList');

if (emails.length === 0) {
emailsList.innerHTML = '<p>No emails found.</p>';
return;
}

const emailsHTML = emails.map(email => `
<div class="email-item ${email.unread ? 'unread' : ''}" onclick="openEmail('${email.id}')">
<div class="email-header">
<div class="email-from">${email.from || 'Unknown Sender'}</div>
<div class="email-date">${formatEmailDate(email.date)}</div>
</div>
<div class="email-subject">${email.subject || 'No Subject'}</div>
<div class="email-snippet">${email.snippet || ''}</div>
</div>
`).join('');

emailsList.innerHTML = emailsHTML;
}

function formatEmailDate(dateString) {
if (!dateString) return '';
const date = new Date(dateString);
const now = new Date();
const diffTime = Math.abs(now - date);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (diffDays === 1) return 'Yesterday';
if (diffDays < 7) return `${diffDays} days ago`;
return date.toLocaleDateString();
}

function openEmail(emailId) {
console.log('Opening email:', emailId);
// TODO: Implement email detail view
}

// Modal functions
function showAddTaskModal() {
document.getElementById('addTaskModal').style.display = 'flex';
document.getElementById('taskTitle').focus();
}

function showAddProjectModal() {
document.getElementById('addProjectModal').style.display = 'flex';
document.getElementById('projectName').focus();
}

function closeModal(modalId) {
document.getElementById(modalId).style.display = 'none';
}

function submitTask(event) {
event.preventDefault();
const title = document.getElementById('taskTitle').value.trim();
const priority = document.getElementById('taskPriority').value;
const description = document.getElementById('taskDescription').value.trim();

if (!title) return;

const newTask = {
id: `task_${Date.now()}`,
title,
priority,
description,
created: new Date()
};

processedTasks.push(newTask);
updateDashboard();
closeModal('addTaskModal');

// Reset form
document.getElementById('taskTitle').value = '';
document.getElementById('taskDescription').value = '';
document.getElementById('taskPriority').value = 'normal';
}

function submitProject(event) {
event.preventDefault();
const name = document.getElementById('projectName').value.trim();
const description = document.getElementById('projectDescription').value.trim();
const dueDate = document.getElementById('projectDueDate').value;

if (!name) return;

const newProject = {
id: `project_${Date.now()}`,
name,
description,
dueDate,
tasks: [],
created: new Date()
};

processedProjects.push(newProject);
updateProjectsList();
closeModal('addProjectModal');

// Reset form
document.getElementById('projectName').value = '';
document.getElementById('projectDescription').value = '';
document.getElementById('projectDueDate').value = '';
}

// Update dashboard
function updateDashboard() {
const tasksList = document.getElementById('tasksList');
if (processedTasks.length > 0) {
const tasksHTML = processedTasks.map(task => `
<li class="task-item ${task.priority === 'urgent' ? 'urgent' : ''}">
<span class="task-title">${task.title}</span>
${task.priority === 'urgent' ? '<span class="task-priority urgent">URGENT</span>' : ''}
${task.priority === 'research' ? '<span class="task-priority research">RESEARCH</span>' : ''}
<div class="task-actions">
<button class="task-action-btn" onclick="archiveTask('${task.id}')" title="Archive">üìÅ</button>
<button class="task-action-btn" onclick="addToCalendar('${task.id}')" title="Add to Calendar">üìÖ</button>
<button class="task-action-btn" onclick="deleteTask('${task.id}')" title="Delete">üóëÔ∏è</button>
</div>
</li>
`).join('');
tasksList.innerHTML = tasksHTML;
}
}

function updateProjectsList() {
const projectList = document.getElementById('projectList');
if (processedProjects.length > 0) {
const projectsHTML = processedProjects.map(project => `
<div class="project-item" onclick="openProject('${project.id}')">
<div class="project-title">${project.name}</div>
<div class="project-desc">${project.description || 'No description'} ${project.dueDate ? `‚Ä¢ Due ${formatProjectDate(project.dueDate)}` : ''}</div>
</div>
`).join('');
projectList.innerHTML = projectsHTML;
}
}

function formatProjectDate(dateString) {
const date = new Date(dateString);
const now = new Date();
const diffTime = date - now;
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (diffDays < 0) return 'Overdue';
if (diffDays === 0) return 'Today';
if (diffDays === 1) return 'Tomorrow';
if (diffDays < 7) return `${diffDays} days`;
return date.toLocaleDateString();
}

// AI Note processing
function processAINote() {
const note = document.getElementById('aiNote')?.value || '';
if (!note.trim()) return;

const btn = document.querySelector('.ai-send-btn');
if (!btn) return;

const originalText = btn.textContent;
btn.textContent = 'processing...';
btn.disabled = true;

// Process using chat logic
const response = processUserMessage(note);

// Show in chat if user is there, otherwise just process
setTimeout(() => {
btn.textContent = 'done';
setTimeout(() => {
btn.textContent = originalText;
btn.disabled = false;
document.getElementById('aiNote').value = '';
}, 1000);
}, 1500);
}

// Task actions
function archiveTask(taskId) {
processedTasks = processedTasks.filter(task => task.id !== taskId);
updateDashboard();
autoSave();
}

function addToCalendar(taskId) {
const task = processedTasks.find(t => t.id === taskId);
if (task) {
alert(`Task "${task.title}" would be added to calendar`);
}
}

function deleteTask(taskId) {
processedTasks = processedTasks.filter(task => task.id !== taskId);
updateDashboard();
autoSave();
}

function openProject(projectId) {
console.log('Opening project:', projectId);
// TODO: Implement project detail view
}

function showMindPage() {
showView('mind');
}

function saveMindNote() {
const input = document.getElementById('mindInput');
const content = input.value.trim();
if (!content) return;

console.log('Saving mind note:', content);

const btn = document.querySelector('.mind-save-btn');
const originalText = btn.textContent;
btn.textContent = 'saved!';
setTimeout(() => {
btn.textContent = originalText;
input.value = '';
}, 1000);
}

// Initialize functions
function updateDateDisplay() {
const dateDisplay = document.getElementById('dateDisplay');
if (dateDisplay) {
const now = new Date();
const options = {
weekday: 'long',
year: 'numeric',
month: 'long',
day: 'numeric'
};
dateDisplay.textContent = now.toLocaleDateString('en-US', options);
}
}

function logout() {
localStorage.removeItem('khizr_assistant_gate');
localStorage.removeItem('khizr_assistant_auth');
window.location.href = 'index.html';
}

function checkAppAuth() {
const gateAuth = localStorage.getItem('khizr_assistant_gate');
if (!gateAuth) {
window.location.href = 'index.html';
return;
}

try {
const authData = JSON.parse(gateAuth);
if (!authData.authenticated || Date.now() > authData.expires) {
localStorage.removeItem('khizr_assistant_gate');
window.location.href = 'index.html';
return;
}
} catch (error) {
localStorage.removeItem('khizr_assistant_gate');
window.location.href = 'index.html';
return;
}
}

function loadSavedData() {
const savedTasks = localStorage.getItem('khizr_processed_tasks');
const savedProjects = localStorage.getItem('khizr_processed_projects');
const savedChat = localStorage.getItem('khizr_chat_history');

if (savedTasks) {
try {
processedTasks = JSON.parse(savedTasks);
} catch (e) {
processedTasks = [];
}
}

if (savedProjects) {
try {
processedProjects = JSON.parse(savedProjects);
} catch (e) {
processedProjects = [];
}
}

if (savedChat) {
try {
chatHistory = JSON.parse(savedChat);
// Restore chat messages
const messagesContainer = document.getElementById('chatMessages');
messagesContainer.innerHTML = ''; // Clear welcome message
chatHistory.forEach(msg => {
addChatMessage(msg.sender, msg.content);
});
} catch (e) {
chatHistory = [];
}
}

updateDashboard();
updateProjectsList();
}

function autoSave() {
localStorage.setItem('khizr_processed_tasks', JSON.stringify(processedTasks));
localStorage.setItem('khizr_processed_projects', JSON.stringify(processedProjects));
localStorage.setItem('khizr_chat_history', JSON.stringify(chatHistory));
}

// Close modals on escape key
document.addEventListener('keydown', function(event) {
if (event.key === 'Escape') {
const modals = document.querySelectorAll('.modal-overlay');
modals.forEach(modal => {
if (modal.style.display === 'flex') {
modal.style.display = 'none';
}
});
}
});

// Close modals on outside click
document.addEventListener('click', function(event) {
if (event.target.classList.contains('modal-overlay')) {
event.target.style.display = 'none';
}
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
updateDateDisplay();
checkAppAuth();
loadSavedData();

const savedTheme = localStorage.getItem('theme') || 'purple';
setTheme(savedTheme);

// Auto-save every 30 seconds
setInterval(autoSave, 30000);
window.addEventListener('beforeunload', autoSave);
});

</script>

</body>
</html>