<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Khizr Assistant - Login</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');
    :root { --primary:#8B5CF6; --bg:#0A0A0B; --bg-card:#111115; --text-primary:#E4E4E7; --text-secondary:#71717A; --border:#27272A; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'JetBrains+Mono',monospace; background:var(--bg); color:var(--text-primary); min-height:100vh; display:flex; align-items:center; justify-content:center; font-size:14px; }
    .auth-container { background:var(--bg-card); border:1px solid var(--border); border-radius:6px; padding:40px; width:100%; max-width:400px; text-align:center; }
    .logo { font-size:18px; font-weight:600; color:var(--primary); margin-bottom:8px; }
    .subtitle { color:var(--text-secondary); font-size:12px; margin-bottom:32px; }
    .input-group { margin-bottom:24px; text-align:left; }
    .input-label { color:var(--text-secondary); font-size:11px; margin-bottom:8px; display:block; text-transform:uppercase; letter-spacing:.5px; }
    .input-field { width:100%; background:transparent; border:1px solid var(--border); border-radius:4px; padding:12px; color:var(--text-primary); font-family:inherit; font-size:13px; transition:border-color .2s ease; }
    .input-field:focus { outline:none; border-color:var(--primary); }
    .input-field::placeholder { color:var(--text-secondary); }
    .login-btn { width:100%; background:var(--primary); border:none; border-radius:4px; padding:12px; color:#fff; font-family:inherit; font-size:13px; font-weight:500; cursor:pointer; transition:opacity .2s ease; }
    .login-btn:hover { opacity:.9; }
    .login-btn:disabled { opacity:.5; cursor:not-allowed; }
    .error-msg { color:#EF4444; font-size:11px; margin-top:12px; display:none; }
    .footer { margin-top:32px; color:var(--text-secondary); font-size:10px; }
    .loading { width:16px; height:16px; border:2px solid transparent; border-top:2px solid #fff; border-radius:50%; animation:spin 1s linear infinite; display:none; margin:0 auto; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .btn-content { display:flex; align-items:center; justify-content:center; gap:8px; }
    .pw-row { position:relative; }
    .toggle { position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:11px; color:var(--text-secondary); cursor:pointer; user-select:none; }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">khizr.assistant</div>
    <div class="subtitle">secure login</div>

    <form id="loginForm" autocomplete="off">
      <div class="input-group">
        <label class="input-label" for="email">email</label>
        <input
          type="email"
          id="email"
          class="input-field"
          placeholder="enter your email"
          required
        />
      </div>

      <div class="input-group pw-row">
        <label class="input-label" for="password">password</label>
        <input
          type="password"
          id="password"
          class="input-field"
          placeholder="enter your password"
          required
        />
        <span id="togglePw" class="toggle">show</span>
      </div>

      <button type="submit" class="login-btn" id="loginBtn">
        <div class="btn-content">
          <span id="btnText">sign in</span>
          <div class="loading" id="loading"></div>
        </div>
      </button>

      <div class="error-msg" id="errorMsg">invalid credentials</div>
    </form>

    <div class="footer">authorized personnel only</div>
    <div class="footer" style="margin-top: 8px; font-size: 9px; opacity: 0.6;">
      Test: admin@khizr.com / admin123
    </div>
  </div>

  <script>
    // Simple authentication for now - will integrate with backend later
    const CONFIG = {
      USERS: [
        { email: 'admin@khizr.com', password: 'admin123', name: 'Khizr Admin' }
      ],
      GATE_KEY: 'khizr_assistant_gate',
      DURATION_MS: 24 * 60 * 60 * 1000
    };

    function safeParse(json) {
      try { return JSON.parse(json); } catch { return null; }
    }

    function isGateAuthenticated() {
      const raw = localStorage.getItem(CONFIG.GATE_KEY);
      if (!raw) return false;
      const data = safeParse(raw);
      if (!data || typeof data !== 'object') return false;
      if (typeof data.expires !== 'number') return false;
      if (Date.now() > data.expires) {
        localStorage.removeItem(CONFIG.GATE_KEY);
        return false;
      }
      return !!data.authenticated;
    }

    // Redirect if gate already passed
    if (isGateAuthenticated()) {
      window.location.href = 'app.html';
    }

    // Show/hide password toggle
    (function setupToggle() {
      const pw = document.getElementById('password');
      const t = document.getElementById('togglePw');
      if (!pw || !t) return;
      t.addEventListener('click', () => {
        const isPw = pw.type === 'password';
        pw.type = isPw ? 'text' : 'password';
        t.textContent = isPw ? 'hide' : 'show';
        pw.focus();
      });
    })();

    // Form handler - Now calls actual backend API
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const loginBtn = document.getElementById('loginBtn');
      const btnText = document.getElementById('btnText');
      const loading = document.getElementById('loading');
      const errorMsg = document.getElementById('errorMsg');

      loginBtn.disabled = true;
      btnText.style.display = 'none';
      loading.style.display = 'block';
      errorMsg.style.display = 'none';

      try {
        // Call actual backend API
        const response = await fetch('https://khizr-assistant-api.onrender.com/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok && data.token) {
          // Store JWT token for the main app
          localStorage.setItem('khizr_assistant_auth', data.token);

          // Also store gate auth for compatibility
          const session = {
            authenticated: true,
            expires: Date.now() + (24 * 60 * 60 * 1000), // 24 hours
            ts: Date.now(),
            user: data.user
          };
          localStorage.setItem(CONFIG.GATE_KEY, JSON.stringify(session));

          // Redirect to main app
          window.location.href = 'app.html';
        } else {
          throw new Error(data.error || 'Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        errorMsg.textContent = error.message || 'Login failed. Please try again.';
        errorMsg.style.display = 'block';
        loginBtn.disabled = false;
        btnText.style.display = 'block';
        loading.style.display = 'none';
      }
    });

    // Autofocus
    document.getElementById('email').focus();



// Gmail functionality (simplified with error handling)
async function connectGmail() {
    const connectBtn = safeGetElement('gmailConnectBtn');
    const refreshBtn = safeGetElement('refreshEmailsBtn');
    const status = safeGetElement('emailStatus');

    if (connectBtn) {
        connectBtn.disabled = true;
        connectBtn.textContent = 'Connecting...';
    }
    
    if (status) {
        status.textContent = 'Authenticating with Gmail...';
    }

    try {
        const response = await fetch(`${API_URL}/gmail/connect`, {
            method: 'POST',
            headers: getAuthHeaders()
        });

        if (response.ok) {
            if (connectBtn) connectBtn.style.display = 'none';
            if (refreshBtn) refreshBtn.style.display = 'inline-block';
            if (status) status.textContent = 'Connected to Gmail ✓';
            await loadEmails();
        } else {
            throw new Error('Failed to connect');
        }
    } catch (error) {
        console.warn('Gmail connection failed:', error);
        if (status) status.textContent = 'Connection failed. Please try again.';
        if (connectBtn) {
            connectBtn.disabled = false;
            connectBtn.textContent = 'Connect Gmail';
        }
    }
}

async function loadEmails() {
    const status = safeGetElement('emailStatus');
    if (status) status.textContent = 'Loading emails...';

    try {
        const response = await fetch(`${API_URL}/gmail/messages`, {
            headers: getAuthHeaders()
        });

        if (response.ok) {
            const data = await response.json();
            displayEmails(data.messages || []);
            if (status) status.textContent = `Loaded ${data.messages?.length || 0} emails`;
        } else {
            throw new Error('Failed to load emails');
        }
    } catch (error) {
        console.warn('Email loading error:', error);
        if (status) status.textContent = 'Failed to load emails';
        displayEmails([]); // Show empty state
    }
}

async function refreshEmails() {
    await loadEmails();
}

function displayEmails(emails) {
    const emailsList = safeGetElement('emailsList');
    if (!emailsList) return;

    if (!emails || emails.length === 0) {
        emailsList.innerHTML = '<p>No emails found.</p>';
        return;
    }

    const emailsHTML = emails.map(email => `
        <div class="email-item ${email.unread ? 'unread' : ''}" onclick="openEmail('${email.id}')">
            <div class="email-header">
                <div class="email-from">${escapeHtml(email.from || 'Unknown Sender')}</div>
                <div class="email-date">${formatEmailDate(email.date)}</div>
            </div>
            <div class="email-subject">${escapeHtml(email.subject || 'No Subject')}</div>
            <div class="email-snippet">${escapeHtml(email.snippet || '')}</div>
        </div>
    `).join('');

    emailsList.innerHTML = emailsHTML;
}

function formatEmailDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        return date.toLocaleDateString();
    } catch (error) {
        return 'Unknown date';
    }
}

function openEmail(emailId) {
    console.log('Opening email:', emailId);
    // TODO: Implement email detail view
    showErrorMessage('Email detail view coming soon!');
}

// Authentication and session management
function logout() {
    localStorage.removeItem('khizr_assistant_gate');
    localStorage.removeItem('khizr_assistant_auth');
    localStorage.removeItem('khizr_processed_tasks');
    localStorage.removeItem('khizr_processed_projects');
    window.location.href = 'index.html';
}

function checkAppAuth() {
    const gateAuth = localStorage.getItem('khizr_assistant_gate');
    if (!gateAuth) {
        console.warn('No gate auth found, redirecting to login');
        window.location.href = 'index.html';
        return false;
    }

    try {
        const authData = JSON.parse(gateAuth);
        if (!authData.authenticated || Date.now() > authData.expires) {
            console.warn('Auth expired, redirecting to login');
            localStorage.removeItem('khizr_assistant_gate');
            window.location.href = 'index.html';
            return false;
        }
        return true;
    } catch (error) {
        console.error('Auth data corrupted:', error);
        localStorage.removeItem('khizr_assistant_gate');
        window.location.href = 'index.html';
        return false;
    }
}

// Event listeners and initialization
function setupEventListeners() {
    // Close modals on escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                if (modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            });
        }
    });

    // Close modals on outside click
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = 'none';
        }
    });

    // Handle form submissions to prevent page reload
    const taskForm = document.querySelector('#addTaskModal form');
    const projectForm = document.querySelector('#addProjectModal form');
    
    if (taskForm) {
        taskForm.addEventListener('submit', submitTask);
    }
    
    if (projectForm) {
        projectForm.addEventListener('submit', submitProject);
    }

    // Add error boundary for unhandled errors
    window.addEventListener('error', function(event) {
        console.error('Unhandled error:', event.error);
        showErrorMessage('An unexpected error occurred. Please refresh the page.');
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        showErrorMessage('A network error occurred. Please check your connection.');
    });
}

// Data sync utilities
function syncLocalData() {
    // This function would sync local data with the server when connection is restored
    // For now, we'll just log that sync is needed
    const hasLocalTasks = localStorage.getItem('khizr_processed_tasks');
    const hasLocalProjects = localStorage.getItem('khizr_processed_projects');
    
    if (hasLocalTasks || hasLocalProjects) {
        console.log('Local data detected - sync needed when server is available');
        // TODO: Implement actual sync logic
    }
}

// Performance monitoring
function trackPerformance() {
    if (window.performance && window.performance.mark) {
        window.performance.mark('khizr-app-loaded');
        
        // Log initialization time
        setTimeout(() => {
            try {
                const loadTime = performance.now();
                console.log(`Khizr Assistant loaded in ${Math.round(loadTime)}ms`);
            } catch (error) {
                // Silently fail if performance API not available
            }
        }, 100);
    }
}

// Main initialization function
function initializeKhizrApp() {
    console.log('🚀 Starting Khizr Assistant initialization...');
    
    try {
        // Check authentication first
        if (!checkAppAuth()) {
            return; // Will redirect to login
        }
        
        // Set up error handling and event listeners
        setupEventListeners();
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'purple';
        setTheme(savedTheme);
        
        // Initialize the main app
        initializeApp();
        
        // Sync any local data
        syncLocalData();
        
        // Track performance
        trackPerformance();
        
        console.log('✅ Khizr Assistant initialization complete');
        
    } catch (error) {
        console.error('❌ Failed to initialize Khizr Assistant:', error);
        showErrorMessage('Failed to initialize the application. Please refresh the page.');
    }
}

// Service worker registration for offline support (if needed)
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registered:', registration);
            })
            .catch(error => {
                console.log('Service Worker registration failed:', error);
            });
    }
}

// Health check function
async function healthCheck() {
    try {
        const response = await fetch(`${API_URL}/health`, {
            headers: getAuthHeaders(),
            timeout: 5000
        });
        
        if (response.ok) {
            console.log('✅ API health check passed');
            return true;
        } else {
            console.warn('⚠️ API health check failed');
            return false;
        }
    } catch (error) {
        console.warn('⚠️ API not reachable:', error.message);
        return false;
    }
}

// Periodic health checks
function startHealthChecks() {
    // Check API health every 5 minutes
    setInterval(async () => {
        const isHealthy = await healthCheck();
        if (!isHealthy && isInitialized) {
            console.warn('API appears to be down, switching to offline mode');
            // Could show an offline indicator here
        }
    }, 300000); // 5 minutes
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 DOM loaded, initializing Khizr Assistant...');
    
    // Add a small delay to ensure all resources are loaded
    setTimeout(() => {
        initializeKhizrApp();
        startHealthChecks();
        // registerServiceWorker(); // Uncomment if you want offline support
    }, 100);
});

// Export functions for global access (if needed)
window.KhizrAssistant = {
    showView,
    setTheme,
    showAddTaskModal,
    showAddProjectModal,
    closeModal,
    processAINote,
    sendChatMessage,
    connectGmail,
    refreshEmails,
    logout
};

// Debug helpers (only in development)
if (window.location.hostname === 'localhost' || window.location.hostname.includes('netlify')) {
    window.KhizrDebug = {
        loadTasks,
        loadProjects,
        loadAgents: loadAgentStatus,
        loadApprovals,
        agents,
        isInitialized,
        healthCheck,
        showErrorMessage
    };
    
    console.log('🔧 Debug helpers available at window.KhizrDebug');
}

// Console welcome message
console.log(`
🤖 Khizr Assistant v1.0
━━━━━━━━━━━━━━━━━━━━━━━
✨ Intelligent agent system loaded
🔧 Debug mode: ${window.location.hostname === 'localhost' ? 'ON' : 'OFF'}
📡 API endpoint: ${API_URL}
━━━━━━━━━━━━━━━━━━━━━━━
`);
</script>

</body>
</html>