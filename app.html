<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khizr Assistant</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

:root {
--primary: #8B5CF6;
--secondary: #EF4444;
--bg: #0A0A0B;
--bg-card: #111115;
--text-primary: #E4E4E7;
--text-secondary: #71717A;
--text-accent: #A855F7;
--border: #27272A;
--border-accent: #3F3F46;
--success: #10B981;
--warning: #F59E0B;
}

.theme-red {
--primary: #EF4444;
--text-accent: #F87171;
}

.theme-purple {
--primary: #8B5CF6;
--text-accent: #A855F7;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'JetBrains Mono', monospace;
background: var(--bg);
color: var(--text-primary);
line-height: 1.6;
font-weight: 400;
min-height: 100vh;
font-size: 14px;
}

.container {
max-width: 900px;
margin: 0 auto;
padding: 40px 20px;
}

/* Header */
.header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 60px;
padding-bottom: 20px;
}

.agent-status {
display: flex;
gap: 8px;
align-items: center;
}

.agent-indicator {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(--success);
}

.agent-indicator.busy {
background: var(--warning);
}

.agent-indicator.offline {
background: var(--text-secondary);
}

.header-controls {
display: flex;
align-items: center;
}

.theme-toggle {
display: flex;
gap: 8px;
align-items: center;
}

.theme-btn {
width: 12px;
height: 12px;
border-radius: 2px;
border: none;
cursor: pointer;
transition: all 0.2s ease;
opacity: 0.6;
}

.theme-btn.purple { background: #8B5CF6; }
.theme-btn.red { background: #EF4444; }

.theme-btn:hover {
opacity: 1;
transform: scale(1.1);
}

.theme-btn.active {
opacity: 1;
}

.logout-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 16px;
padding: 4px;
border-radius: 4px;
transition: all 0.2s ease;
margin-left: 16px;
}

.logout-btn:hover {
color: var(--primary);
background: rgba(139, 92, 246, 0.1);
}

/* Navigation */
.nav {
display: flex;
gap: 30px;
margin-bottom: 40px;
font-size: 13px;
font-weight: 500;
}

.nav-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
transition: color 0.2s ease;
position: relative;
padding: 0;
font-family: inherit;
font-size: inherit;
}

.nav-btn:hover {
color: var(--text-primary);
}

.nav-btn.active {
color: var(--primary);
}

.nav-btn.active::after {
content: '';
position: absolute;
bottom: -8px;
left: 0;
width: 100%;
height: 1px;
background: var(--primary);
}

/* Notification Badge */
.notification-badge {
position: relative;
}

.notification-badge::after {
content: attr(data-count);
position: absolute;
top: -8px;
right: -8px;
background: var(--secondary);
color: white;
border-radius: 50%;
width: 16px;
height: 16px;
font-size: 10px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 500;
}

.notification-badge[data-count="0"]::after {
display: none;
}

/* Main Layout */
.today-view {
display: grid;
grid-template-columns: 1.5fr 1fr;
gap: 60px;
}

/* Cards */
.code-card {
padding: 0;
margin-bottom: 48px;
font-size: 13px;
}

.code-card.boxed {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
padding: 24px;
}

.section-header {
color: var(--text-accent);
font-size: 12px;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}

.add-btn {
background: var(--primary);
border: none;
border-radius: 3px;
padding: 4px 8px;
color: white;
cursor: pointer;
font-size: 10px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.add-btn:hover {
opacity: 0.9;
}

/* Date Display */
.date-display {
font-size: 16px;
font-weight: 500;
color: var(--text-primary);
text-transform: capitalize;
}

/* Tasks */
.task-list {
list-style: none;
}

.task-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 0;
transition: all 0.2s ease;
cursor: pointer;
}

.task-item:hover {
color: var(--primary);
padding-left: 12px;
}

.task-item.urgent {
border-left: 2px solid var(--secondary);
padding-left: 8px;
}

.task-item.urgent:hover {
padding-left: 16px;
}

.task-title {
font-weight: 400;
flex: 1;
}

.task-priority {
font-size: 10px;
padding: 2px 6px;
border-radius: 3px;
margin-right: 8px;
font-weight: 500;
}

.task-priority.urgent {
background: var(--secondary);
color: white;
}

.task-priority.research {
background: var(--primary);
color: white;
}

.task-actions {
display: flex;
gap: 4px;
opacity: 0;
transition: opacity 0.2s ease;
}

.task-item:hover .task-actions {
opacity: 1;
}

.task-action-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 12px;
padding: 2px;
border-radius: 2px;
transition: all 0.2s ease;
}

.task-action-btn:hover {
color: var(--primary);
background: rgba(139, 92, 246, 0.1);
}

/* Agent Status Cards */
.agent-card {
background: rgba(139, 92, 246, 0.05);
border: 1px solid var(--border);
border-radius: 6px;
padding: 12px;
margin-bottom: 8px;
}

.agent-card.busy {
border-color: var(--warning);
background: rgba(245, 158, 11, 0.05);
}

.agent-card.offline {
opacity: 0.6;
}

.agent-name {
font-size: 11px;
font-weight: 600;
color: var(--primary);
margin-bottom: 4px;
}

.agent-task {
font-size: 10px;
color: var(--text-secondary);
}

/* AI Input */
.ai-input-container {
position: relative;
}

.ai-prompt {
color: var(--text-accent);
font-size: 12px;
margin-bottom: 12px;
font-weight: 500;
}

.ai-textarea {
width: 100%;
background: transparent;
border: none;
padding: 0;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
resize: none;
height: 100px;
transition: border-color 0.2s ease;
}

.ai-textarea:focus {
outline: none;
}

.ai-textarea::placeholder {
color: var(--text-secondary);
font-style: italic;
}

.ai-send-btn {
position: absolute;
bottom: 0;
right: 0;
background: var(--primary);
border: none;
border-radius: 3px;
padding: 6px 12px;
color: white;
cursor: pointer;
font-size: 11px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.ai-send-btn:hover {
opacity: 0.9;
transform: scale(0.98);
}

/* Chat Interface */
.chat-container {
display: flex;
flex-direction: column;
height: 500px;
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
}

.chat-messages {
flex: 1;
padding: 20px;
overflow-y: auto;
display: flex;
flex-direction: column;
gap: 16px;
}

.chat-message {
display: flex;
flex-direction: column;
max-width: 80%;
}

.chat-message.user {
align-self: flex-end;
}

.chat-message.assistant {
align-self: flex-start;
}

.message-content {
padding: 12px 16px;
border-radius: 8px;
font-size: 13px;
}

.chat-message.user .message-content {
background: var(--primary);
color: white;
}

.chat-message.assistant .message-content {
background: rgba(139, 92, 246, 0.1);
border: 1px solid var(--border);
color: var(--text-primary);
}

.message-time {
font-size: 10px;
color: var(--text-secondary);
margin-top: 4px;
padding: 0 4px;
}

.chat-input-container {
padding: 16px;
border-top: 1px solid var(--border);
display: flex;
gap: 8px;
}

.chat-input {
flex: 1;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 12px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
}

.chat-input:focus {
outline: none;
border-color: var(--primary);
}

.chat-send-btn {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.chat-send-btn:hover {
opacity: 0.9;
}

.chat-send-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Mind Button */
.mind-btn {
background: transparent;
border: none;
padding: 0;
color: var(--primary);
cursor: pointer;
font-size: 13px;
font-family: inherit;
font-weight: 500;
width: 100%;
transition: all 0.2s ease;
text-align: left;
}

.mind-btn:hover {
color: var(--text-primary);
}

/* Mind Textarea */
.mind-textarea {
width: 100%;
min-height: 120px;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 16px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
resize: vertical;
transition: border-color 0.2s ease;
}

.mind-textarea:focus {
outline: none;
border-color: var(--primary);
}

.mind-textarea::placeholder {
color: var(--text-secondary);
font-style: italic;
}

.mind-save-btn {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
margin-top: 12px;
transition: all 0.2s ease;
}

.mind-save-btn:hover {
opacity: 0.9;
}

/* Time Events */
.time-list {
list-style: none;
}

.time-item {
display: flex;
align-items: center;
padding: 6px 0;
font-family: inherit;
}

.time {
color: var(--primary);
font-weight: 500;
min-width: 80px;
font-size: 12px;
}

.time-separator {
color: var(--text-secondary);
margin: 0 16px;
font-weight: 300;
}

.event-title {
color: var(--text-primary);
font-weight: 400;
}

/* Views */
.project-view, .mind-view, .chat-view, .emails-view, .goals-view, .insights-view, .approvals-view {
display: none;
}

.project-view.active, .mind-view.active, .chat-view.active, .emails-view.active, .goals-view.active, .insights-view.active, .approvals-view.active {
display: block;
}

/* Project Items */
.project-item {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
padding: 16px;
margin-bottom: 12px;
cursor: pointer;
transition: all 0.2s ease;
}

.project-item:hover {
border-color: var(--primary);
background: rgba(139, 92, 246, 0.04);
}

.project-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 4px;
}

.project-desc {
color: var(--text-secondary);
font-size: 12px;
}

/* Approval Cards */
.approval-item {
background: rgba(245, 158, 11, 0.1);
border: 1px solid var(--warning);
border-radius: 6px;
padding: 16px;
margin-bottom: 12px;
}

.approval-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 8px;
}

.approval-title {
font-weight: 600;
color: var(--warning);
font-size: 13px;
}

.approval-cost {
font-size: 11px;
color: var(--text-secondary);
}

.approval-description {
font-size: 12px;
color: var(--text-primary);
margin-bottom: 12px;
line-height: 1.4;
}

.approval-actions {
display: flex;
gap: 8px;
}

.approve-btn {
background: var(--success);
border: none;
border-radius: 4px;
padding: 6px 12px;
color: white;
cursor: pointer;
font-size: 11px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.reject-btn {
background: var(--secondary);
border: none;
border-radius: 4px;
padding: 6px 12px;
color: white;
cursor: pointer;
font-size: 11px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.approve-btn:hover, .reject-btn:hover {
opacity: 0.9;
}

/* Modal styles */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
}

.modal {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 8px;
padding: 24px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
}

.modal-close {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 16px;
padding: 4px;
}

.modal-close:hover {
color: var(--primary);
}

.form-group {
margin-bottom: 16px;
}

.form-label {
display: block;
font-size: 12px;
font-weight: 500;
color: var(--text-accent);
margin-bottom: 6px;
}

.form-input, .form-textarea {
width: 100%;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 12px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
}

.form-textarea {
resize: vertical;
min-height: 80px;
}

.form-input:focus, .form-textarea:focus {
outline: none;
border-color: var(--primary);
}

.form-buttons {
display: flex;
gap: 8px;
justify-content: flex-end;
margin-top: 20px;
}

.btn-secondary {
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 16px;
color: var(--text-secondary);
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.btn-secondary:hover {
border-color: var(--primary);
color: var(--primary);
}

.btn-primary {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.btn-primary:hover {
opacity: 0.9;
}

/* Email styles */
.email-item {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 4px;
padding: 12px;
margin-bottom: 8px;
cursor: pointer;
transition: all 0.2s ease;
}

.email-item:hover {
border-color: var(--primary);
background: rgba(139, 92, 246, 0.04);
}

.email-item.unread {
border-left: 3px solid var(--primary);
}

.email-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 4px;
}

.email-from {
font-weight: 500;
color: var(--text-primary);
font-size: 12px;
}

.email-date {
font-size: 10px;
color: var(--text-secondary);
}

.email-subject {
font-size: 13px;
color: var(--text-primary);
margin-bottom: 4px;
}

.email-snippet {
font-size: 11px;
color: var(--text-secondary);
line-height: 1.4;
}

/* Loading states */
.loading {
opacity: 0.6;
pointer-events: none;
}

.error-message {
color: var(--secondary);
font-size: 12px;
padding: 8px;
background: rgba(239, 68, 68, 0.1);
border: 1px solid var(--secondary);
border-radius: 4px;
margin-bottom: 16px;
}

/* Responsive */
@media (max-width: 768px) {
.container {
padding: 20px 16px;
}

.today-view {
grid-template-columns: 1fr;
gap: 32px;
}

.nav {
gap: 20px;
margin-bottom: 32px;
}

.header {
margin-bottom: 40px;
}

.chat-container {
height: 400px;
}

.modal {
width: 95%;
padding: 20px;
}
}
</style>
</head>
<body class="theme-purple">

<div class="container">
<!-- Header with Agent Status -->
<header class="header">
<div class="agent-status" id="agentStatus">
<div class="agent-indicator" id="browserAgent" title="Browser Agent"></div>
<div class="agent-indicator" id="coderAgent" title="Coder Agent"></div>
<div class="agent-indicator" id="pmAgent" title="PM Agent"></div>
<div class="agent-indicator" id="researchAgent" title="Research Agent"></div>
</div>

<div class="header-controls">
<div class="theme-toggle">
<button class="theme-btn purple active" onclick="setTheme('purple')"></button>
<button class="theme-btn red" onclick="setTheme('red')"></button>
</div>
<button class="logout-btn" onclick="logout()" title="Logout">üö™</button>
</div>
</header>

<!-- Navigation -->
<nav class="nav">
<button class="nav-btn active" onclick="showView('today')">today</button>
<button class="nav-btn" onclick="showView('projects')">projects</button>
<button class="nav-btn" onclick="showView('goals')">goals</button>
<button class="nav-btn notification-badge" data-count="0" onclick="showView('approvals')" id="approvalsNavBtn">approvals</button>
<button class="nav-btn" onclick="showView('chat')">ai chat</button>
<button class="nav-btn" onclick="showView('emails')">emails</button>
</nav>

<!-- Today View -->
<div id="today-view" class="today-view">
<div class="main-content">
<!-- Date Display -->
<div class="code-card">
<div class="section-header">today</div>
<div class="date-display" id="dateDisplay">Loading...</div>
</div>

<!-- Dynamic Tasks -->
<div class="code-card" id="tasksContainer">
<div class="section-header">
tasks
<button class="add-btn" onclick="showAddTaskModal()">+ add</button>
</div>
<ul class="task-list" id="tasksList">
<li style="color: var(--text-secondary); font-style: italic;">Loading tasks...</li>
</ul>
</div>

<!-- AI Input -->
<div class="code-card">
<div class="section-header">quick process</div>
<div class="ai-input-container">
<div class="ai-prompt">tell me what's on your mind</div>
<textarea
class="ai-textarea"
placeholder="? research question | zz task | !! urgent | og preserve note"
id="aiNote"
></textarea>
<button class="ai-send-btn" onclick="processAINote()">run</button>
</div>
</div>
</div>
</div>

<div class="sidebar">
<!-- Agent Status -->
<div class="code-card">
<div class="section-header">agents</div>
<div id="agentCards">
<p style="color: var(--text-secondary); font-size: 11px;">Loading agent status...</p>
</div>
</div>

<!-- Time-bound Events -->
<div class="code-card">
<div class="section-header">timebound</div>
<ul class="time-list" id="timeEvents">
<li class="time-item">
<span class="time">1:00 PM</span>
<span class="time-separator">-</span>
<span class="event-title">meeting with neil</span>
</li>
<li class="time-item">
<span class="time">2:00 PM</span>
<span class="time-separator">-</span>
<span class="event-title">party</span>
</li>
<li class="time-item">
<span class="time">6:00 PM</span>
<span class="time-separator">-</span>
<span class="event-title">gym session</span>
</li>
</ul>
</div>

<!-- Quick Actions -->
<button class="mind-btn" onclick="showMindPage()">
 on my mind
</button>
</div>
</div>

<!-- Other Views -->
<div id="project-view" class="project-view">
<div class="code-card boxed">
<div class="section-header">
projects
<button class="add-btn" onclick="showAddProjectModal()">+ add</button>
</div>
<div class="project-list" id="projectList">
<p style="color: var(--text-secondary); font-style: italic;">Loading projects...</p>
</div>
</div>
</div>

<!-- Approvals View -->
<div id="approvals-view" class="approvals-view">
<div class="code-card boxed">
<div class="section-header">approvals needed</div>
<div id="approvalsList">
<p style="color: var(--text-secondary);">Loading approvals...</p>
</div>
</div>
</div>

<div id="goals-view" class="goals-view">
<div class="code-card boxed">
<div class="section-header">goals</div>
<p>Goals tracking coming soon...</p>
</div>
</div>

<div id="mind-view" class="mind-view">
<div class="code-card boxed">
<div class="section-header">on my mind</div>
<textarea
id="mindInput"
class="mind-textarea"
placeholder="Share your thoughts, ideas, concerns..."
></textarea>
<button class="mind-save-btn" onclick="saveMindNote()">save thought</button>
</div>
</div>

<!-- AI Chat View -->
<div id="chat-view" class="chat-view">
<div class="code-card boxed">
<div class="section-header">ai chat</div>
<div class="chat-container">
<div class="chat-messages" id="chatMessages">
<div class="chat-message assistant">
<div class="message-content">
Hey! I'm your AI assistant. You can ask me anything or use our prefix system:
<br><br>
<strong>?</strong> research questions ‚Ä¢ <strong>zz</strong> tasks ‚Ä¢ <strong>og</strong> preserve notes ‚Ä¢ <strong>!!</strong> urgent items
<br><br>
What's on your mind?
</div>
<div class="message-time">Just now</div>
</div>
</div>
<div class="chat-input-container">
<input 
type="text" 
class="chat-input" 
id="chatInput" 
placeholder="Type your message or use prefixes: ? zz og !!"
onkeypress="handleChatKeyPress(event)"
>
<button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
</div>
</div>
</div>
</div>

<!-- Email View -->
<div id="emails-view" class="emails-view">
<div class="code-card boxed">
<div class="section-header">emails</div>
<div class="emails-controls" style="margin-bottom: 20px;">
<button class="btn-primary" onclick="connectGmail()" id="gmailConnectBtn">
Connect Gmail
</button>
<button class="btn-secondary" onclick="refreshEmails()" id="refreshEmailsBtn" style="display:none;">
Refresh
</button>
<span id="emailStatus" style="margin-left: 12px; font-size: 11px; color: var(--text-secondary);"></span>
</div>
<div class="emails-list" id="emailsList">
<p>Click "Connect Gmail" to start managing your emails...</p>
</div>
</div>
</div>

</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal-overlay" style="display: none;">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Add New Task</h3>
<button class="modal-close" onclick="closeModal('addTaskModal')">√ó</button>
</div>
<form onsubmit="submitTask(event)">
<div class="form-group">
<label class="form-label">Task Title</label>
<input type="text" class="form-input" id="taskTitle" required>
</div>
<div class="form-group">
<label class="form-label">Priority</label>
<select class="form-input" id="taskPriority">
<option value="normal">Normal</option>
<option value="urgent">Urgent</option>
<option value="low">Low</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Assign To</label>
<select class="form-input" id="taskAssignTo">
<option value="human">Me</option>
<option value="browser_agent">Browser Agent</option>
<option value="coder_agent">Coder Agent</option>
<option value="pm_agent">PM Agent</option>
<option value="researcher_agent">Research Agent</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Description (optional)</label>
<textarea class="form-textarea" id="taskDescription" placeholder="Additional details..."></textarea>
</div>
<div class="form-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
<button type="submit" class="btn-primary">Add Task</button>
</div>
</form>
</div>
</div>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal-overlay" style="display: none;">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Add New Project</h3>
<button class="modal-close" onclick="closeModal('addProjectModal')">√ó</button>
</div>
<form onsubmit="submitProject(event)">
<div class="form-group">
<label class="form-label">Project Name</label>
<input type="text" class="form-input" id="projectName" required>
</div>
<div class="form-group">
<label class="form-label">Description</label>
<textarea class="form-textarea" id="projectDescription" placeholder="What is this project about?"></textarea>
</div>
<div class="form-group">
<label class="form-label">Due Date (optional)</label>
<input type="date" class="form-input" id="projectDueDate">
</div>
<div class="form-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('addProjectModal')">Cancel</button>
<button type="submit" class="btn-primary">Add Project</button>
</div>
</form>
</div>
</div>

<script>
const API_URL = "https://khizr-assistant-api.onrender.com";

// Global state
let agents = [];
let currentUser = null;
let notifications = 0;
let pendingApprovals = [];
let isInitialized = false;

// Safe element finder
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Element with id '${id}' not found`);
    }
    return element;
}

// Safe HTML setter
function safeSetHTML(elementId, html) {
    const element = safeGetElement(elementId);
    if (element) {
        element.innerHTML = html;
    }
}

// Safe attribute setter
function safeSetAttribute(elementId, attribute, value) {
    const element = safeGetElement(elementId);
    if (element) {
        element.setAttribute(attribute, value);
    }
}

// Authentication helper
function getAuthHeaders() {
    const token = localStorage.getItem('khizr_assistant_auth') || 'mock-token';
    return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
}

// Error handling helper
function handleError(error, context = '') {
    console.error(`Error in ${context}:`, error);
    // Show user-friendly error message
    showErrorMessage(`Something went wrong${context ? ' with ' + context : ''}. Please try again.`);
}

function showErrorMessage(message) {
    // Create or update error display
    let errorDiv = document.getElementById('globalError');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'globalError';
        errorDiv.className = 'error-message';
        errorDiv.style.position = 'fixed';
        errorDiv.style.top = '20px';
        errorDiv.style.right = '20px';
        errorDiv.style.zIndex = '9999';
        document.body.appendChild(errorDiv);
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }, 5000);
}

// Initialize application
async function initializeApp() {
    try {
        if (isInitialized) return;
        
        console.log('Initializing Khizr Assistant...');
        
        // Set loading states
        safeSetHTML('dateDisplay', 'Loading...');
        safeSetHTML('tasksList', '<li style="color: var(--text-secondary); font-style: italic;">Loading tasks...</li>');
        safeSetHTML('agentCards', '<p style="color: var(--text-secondary); font-size: 11px;">Loading agent status...</p>');
        
        updateDateDisplay();
        
        // Try to load data, but don't fail if APIs are not ready
        await Promise.allSettled([
            loadAgentStatus(),
            loadTasks(),
            loadProjects(),
            loadApprovals(),
            loadChatHistory()
        ]);
        
        // Set up periodic updates only if initialization succeeds
        setInterval(() => {
            if (isInitialized) {
                loadAgentStatus().catch(err => console.warn('Agent status update failed:', err));
            }
        }, 30000);
        
        setInterval(() => {
            if (isInitialized) {
                loadApprovals().catch(err => console.warn('Approvals update failed:', err));
            }
        }, 60000);
        
        isInitialized = true;
        console.log('Khizr Assistant initialized successfully');
        
    } catch (error) {
        handleError(error, 'initialization');
    }
}

// Load agent status with fallback
async function loadAgentStatus() {
    try {
        // Mock data for when API is not available
        const mockAgents = [
            { name: 'browser_agent', display_name: 'Browser Agent', status: 'available' },
            { name: 'coder_agent', display_name: 'Coder Agent', status: 'available' },
            { name: 'pm_agent', display_name: 'PM Agent', status: 'available' },
            { name: 'researcher_agent', display_name: 'Research Agent', status: 'available' }
        ];
        
        try {
            const response = await fetch(`${API_URL}/agents`, {
                headers: getAuthHeaders()
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.agents) {
                    agents = data.agents;
                } else {
                    agents = mockAgents;
                }
            } else {
                agents = mockAgents;
            }
        } catch (fetchError) {
            console.warn('Using mock agent data:', fetchError.message);
            agents = mockAgents;
        }
        
        updateAgentIndicators();
        updateAgentCards();
        
    } catch (error) {
        console.warn('Failed to load agent status:', error);
        // Set default offline state
        agents = [
            { name: 'browser_agent', display_name: 'Browser Agent', status: 'offline' },
            { name: 'coder_agent', display_name: 'Coder Agent', status: 'offline' },
            { name: 'pm_agent', display_name: 'PM Agent', status: 'offline' },
            { name: 'researcher_agent', display_name: 'Research Agent', status: 'offline' }
        ];
        updateAgentIndicators();
        updateAgentCards();
    }
}

function updateAgentIndicators() {
    agents.forEach(agent => {
        const indicatorName = agent.name.replace('_agent', 'Agent');
        const indicator = safeGetElement(indicatorName);
        if (indicator) {
            indicator.className = `agent-indicator ${agent.status}`;
        }
    });
}

function updateAgentCards() {
    if (agents.length === 0) {
        safeSetHTML('agentCards', '<p style="color: var(--text-secondary); font-size: 11px;">No agent data available</p>');
        return;
    }

    const cardsHTML = agents.map(agent => `
        <div class="agent-card ${agent.status}">
            <div class="agent-name">${agent.display_name}</div>
            <div class="agent-task">${agent.status === 'busy' ? 'Working on task...' : agent.status}</div>
        </div>
    `).join('');

    safeSetHTML('agentCards', cardsHTML);
}

// Load tasks with fallback
async function loadTasks() {
    try {
        let tasks = [];
        
        try {
            const response = await fetch(`${API_URL}/tasks?limit=10`, {
                headers: getAuthHeaders()
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.tasks) {
                    tasks = data.tasks;
                }
            }
        } catch (fetchError) {
            console.warn('Tasks API not available:', fetchError.message);
            // Load from localStorage as fallback
            const savedTasks = localStorage.getItem('khizr_processed_tasks');
            if (savedTasks) {
                try {
                    tasks = JSON.parse(savedTasks);
                } catch (parseError) {
                    console.warn('Failed to parse saved tasks');
                    tasks = [];
                }
            }
        }
        
        displayTasks(tasks);
        
    } catch (error) {
        console.warn('Failed to load tasks:', error);
        safeSetHTML('tasksList', '<li style="color: var(--text-secondary); font-style: italic;">Unable to load tasks. Please try again later.</li>');
    }
}

function displayTasks(tasks) {
    const tasksList = safeGetElement('tasksList');
    if (!tasksList) return;

    if (!tasks || tasks.length === 0) {
        tasksList.innerHTML = '<li style="color: var(--text-secondary); font-style: italic;">No tasks yet. Create one above!</li>';
        return;
    }

    const tasksHTML = tasks.map(task => `
        <li class="task-item ${task.priority === 'urgent' ? 'urgent' : ''}">
            <span class="task-title">${escapeHtml(task.title || 'Untitled Task')}</span>
            ${task.priority === 'urgent' ? '<span class="task-priority urgent">URGENT</span>' : ''}
            ${task.task_type === 'agent' ? '<span class="task-priority research">AGENT</span>' : ''}
            <div class="task-actions">
                <button class="task-action-btn" onclick="completeTask('${task.id}')" title="Complete">‚úì</button>
                <button class="task-action-btn" onclick="deleteTask('${task.id}')" title="Delete">üóëÔ∏è</button>
            </div>
        </li>
    `).join('');

    tasksList.innerHTML = tasksHTML;
}

// Load projects with fallback
async function loadProjects() {
    try {
        let projects = [];
        
        try {
            const response = await fetch(`${API_URL}/projects`, {
                headers: getAuthHeaders()
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.projects) {
                    projects = data.projects;
                }
            }
        } catch (fetchError) {
            console.warn('Projects API not available:', fetchError.message);
            // Load from localStorage as fallback
            const savedProjects = localStorage.getItem('khizr_processed_projects');
            if (savedProjects) {
                try {
                    projects = JSON.parse(savedProjects);
                } catch (parseError) {
                    console.warn('Failed to parse saved projects');
                    projects = [];
                }
            }
        }
        
        displayProjects(projects);
        
    } catch (error) {
        console.warn('Failed to load projects:', error);
        safeSetHTML('projectList', '<p style="color: var(--text-secondary); font-style: italic;">Unable to load projects. Please try again later.</p>');
    }
}

function displayProjects(projects) {
    if (!projects || projects.length === 0) {
        safeSetHTML('projectList', '<p style="color: var(--text-secondary); font-style: italic;">No projects yet. Create one above!</p>');
        return;
    }

    const projectsHTML = projects.map(project => `
        <div class="project-item" onclick="openProject('${project.id}')">
            <div class="project-title">${escapeHtml(project.name || 'Untitled Project')}</div>
            <div class="project-desc">${escapeHtml(project.description || 'No description')}</div>
        </div>
    `).join('');

    safeSetHTML('projectList', projectsHTML);
}

// Load pending approvals with fallback
async function loadApprovals() {
    try {
        let approvals = [];
        
        try {
            const response = await fetch(`${API_URL}/approvals/pending`, {
                headers: getAuthHeaders()
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.approvals) {
                    approvals = data.approvals;
                }
            }
        } catch (fetchError) {
            console.warn('Approvals API not available:', fetchError.message);
            approvals = []; // No fallback for approvals
        }
        
        pendingApprovals = approvals;
        displayApprovals(approvals);
        updateApprovalsBadge(approvals.length);
        
    } catch (error) {
        console.warn('Failed to load approvals:', error);
        safeSetHTML('approvalsList', '<p style="color: var(--text-secondary);">Unable to load approvals. Please try again later.</p>');
    }
}

function displayApprovals(approvals) {
    if (!approvals || approvals.length === 0) {
        safeSetHTML('approvalsList', '<p style="color: var(--text-secondary);">No approvals needed right now.</p>');
        return;
    }

    const approvalsHTML = approvals.map(approval => `
        <div class="approval-item">
            <div class="approval-header">
                <div class="approval-title">${escapeHtml(approval.title || 'Approval Required')}</div>
                ${approval.estimated_cost ? `<div class="approval-cost">${approval.estimated_cost}</div>` : ''}
            </div>
            <div class="approval-description">${escapeHtml(approval.description || 'No description available')}</div>
            <div class="approval-actions">
                <button class="approve-btn" onclick="handleApproval('${approval.id}', 'approved')">Approve</button>
                <button class="reject-btn" onclick="handleApproval('${approval.id}', 'rejected')">Reject</button>
            </div>
        </div>
    `).join('');

    safeSetHTML('approvalsList', approvalsHTML);
}

function updateApprovalsBadge(count) {
    safeSetAttribute('approvalsNavBtn', 'data-count', count);
}

// Chat functionality with offline support
function sendChatMessage() {
    const input = safeGetElement('chatInput');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message) return;

    addChatMessage('user', message);
    input.value = '';

    const sendBtn = safeGetElement('chatSendBtn');
    if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Thinking...';
    }

    processChatMessage(message);
}

async function processChatMessage(message) {
    try {
        let responseMessage = '';
        let shouldRefreshTasks = false;
        
        try {
            const response = await fetch(`${API_URL}/chat/process`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ message })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    responseMessage = data.message;
                    shouldRefreshTasks = ['task_created', 'urgent_created', 'research_created'].includes(data.type);
                } else {
                    responseMessage = 'Sorry, I encountered an error processing your message.';
                }
            } else {
                throw new Error('API request failed');
            }
        } catch (fetchError) {
            console.warn('Chat API not available, using offline processing:', fetchError.message);
            // Offline chat processing
            responseMessage = processMessageOffline(message);
            shouldRefreshTasks = message.startsWith('zz') || message.startsWith('!!') || message.startsWith('?');
        }
        
        addChatMessage('assistant', responseMessage);
        
        if (shouldRefreshTasks) {
            await loadTasks();
        }
        
    } catch (error) {
        console.warn('Chat processing error:', error);
        addChatMessage('assistant', 'Connection error. Your message has been saved locally.');
    } finally {
        const sendBtn = safeGetElement('chatSendBtn');
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        }
    }
}

function processMessageOffline(message) {
    const trimmed = message.trim();
    
    if (trimmed.startsWith('?')) {
        const question = trimmed.substring(1).trim();
        // Save to localStorage
        saveTaskToLocal({
            id: `research_${Date.now()}`,
            title: `Research: ${question}`,
            priority: 'medium',
            task_type: 'agent',
            created: new Date()
        });
        return `I've added "${question}" to your research queue. (Offline mode - will sync when connected)`;
    }
    
    if (trimmed.toLowerCase().startsWith('zz')) {
        const taskTitle = trimmed.substring(2).trim();
        saveTaskToLocal({
            id: `task_${Date.now()}`,
            title: taskTitle,
            priority: 'normal',
            task_type: 'manual',
            created: new Date()
        });
        return `Task created: "${taskTitle}". (Offline mode - will sync when connected)`;
    }
    
    if (trimmed.startsWith('!!')) {
        const urgentTask = trimmed.substring(2).trim();
        saveTaskToLocal({
            id: `urgent_${Date.now()}`,
            title: urgentTask,
            priority: 'urgent',
            task_type: 'manual',
            created: new Date()
        });
        return `üî• Urgent task created: "${urgentTask}". (Offline mode - will sync when connected)`;
    }
    
    const responses = [
        `I understand you're thinking about: "${trimmed}". (Offline mode - limited processing available)`,
        `Got it: "${trimmed}". Use prefixes like "zz" for tasks or "?" for research questions.`,
        `Thanks for sharing. "${trimmed}" has been noted. (Offline mode)`
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
}

function saveTaskToLocal(task) {
    try {
        const saved = localStorage.getItem('khizr_processed_tasks');
        let tasks = saved ? JSON.parse(saved) : [];
        tasks.push(task);
        localStorage.setItem('khizr_processed_tasks', JSON.stringify(tasks));
        loadTasks(); // Refresh display
    } catch (error) {
        console.warn('Failed to save task locally:', error);
    }
}

function addChatMessage(sender, content) {
    const messagesContainer = safeGetElement('chatMessages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;

    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    messageDiv.innerHTML = `
        <div class="message-content">${escapeHtml(content)}</div>
        <div class="message-time">${timeString}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Load chat history with fallback
async function loadChatHistory() {
    try {
        const response = await fetch(`${API_URL}/chat/history`, {
            headers: getAuthHeaders()
        });
        const data = await response.json();

        if (data.success && data.chat_history.length > 0) {
            const messagesContainer = safeGetElement('chatMessages');
            if (messagesContainer) {
                messagesContainer.innerHTML = ''; // Clear existing messages
                data.chat_history.forEach(msg => {
                    addChatMessage('user', msg.description);
                    // Add a simple response for historical messages
                    addChatMessage('assistant', 'Message processed and stored in your knowledge base.');
                });
            }
        } else {
            // Welcome message is already in HTML, no need to add another
        }
    } catch (error) {
        console.warn('Failed to load chat history:', error);
        // Keep the default welcome message in HTML
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
}

// Task management
async function submitTask(event) {
    event.preventDefault();
    
    const titleElement = safeGetElement('taskTitle');
    const priorityElement = safeGetElement('taskPriority');
    const assignToElement = safeGetElement('taskAssignTo');
    const descriptionElement = safeGetElement('taskDescription');
    
    if (!titleElement) return;
    
    const title = titleElement.value.trim();
    const priority = priorityElement?.value || 'normal';
    const assigned_to = assignToElement?.value || 'human';
    const description = descriptionElement?.value.trim() || '';

    if (!title) return;

    try {
        const taskData = {
            title,
            priority,
            assigned_to: assigned_to === 'human' ? null : assigned_to,
            task_type: assigned_to === 'human' ? 'manual' : 'agent',
            description,
            id: `task_${Date.now()}`,
            created: new Date()
        };
        
        try {
            const response = await fetch(`${API_URL}/tasks`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(taskData)
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    closeModal('addTaskModal');
                    await loadTasks();
                    resetTaskForm();
                    return;
                }
            }
            throw new Error('API request failed');
        } catch (fetchError) {
            console.warn('Task API not available, saving locally:', fetchError.message);
            // Save locally
            saveTaskToLocal(taskData);
            closeModal('addTaskModal');
            resetTaskForm();
            showErrorMessage('Task saved locally. Will sync when connected to server.');
        }
        
    } catch (error) {
        handleError(error, 'creating task');
    }
}

function resetTaskForm() {
    const elements = ['taskTitle', 'taskDescription'];
    elements.forEach(id => {
        const element = safeGetElement(id);
        if (element) element.value = '';
    });
    
    const priorityElement = safeGetElement('taskPriority');
    const assignElement = safeGetElement('taskAssignTo');
    
    if (priorityElement) priorityElement.value = 'normal';
    if (assignElement) assignElement.value = 'human';
}

async function completeTask(taskId) {
    try {
        const response = await fetch(`${API_URL}/tasks/${taskId}/status`, {
            method: 'PATCH',
            headers: getAuthHeaders(),
            body: JSON.stringify({ status: 'completed' })
        });

        if (response.ok) {
            await loadTasks();
        } else {
            // Remove from local storage as fallback
            removeTaskFromLocal(taskId);
        }
    } catch (error) {
        console.warn('Complete task API error, removing locally:', error);
        removeTaskFromLocal(taskId);
    }
}

async function deleteTask(taskId) {
    await completeTask(taskId);
}

function removeTaskFromLocal(taskId) {
    try {
        const saved = localStorage.getItem('khizr_processed_tasks');
        if (saved) {
            let tasks = JSON.parse(saved);
            tasks = tasks.filter(task => task.id !== taskId);
            localStorage.setItem('khizr_processed_tasks', JSON.stringify(tasks));
            loadTasks();
        }
    } catch (error) {
        console.warn('Failed to remove task locally:', error);
    }
}

// Project management
async function submitProject(event) {
    event.preventDefault();
    
    const nameElement = safeGetElement('projectName');
    const descriptionElement = safeGetElement('projectDescription');
    const dueDateElement = safeGetElement('projectDueDate');
    
    if (!nameElement) return;
    
    const name = nameElement.value.trim();
    const description = descriptionElement?.value.trim() || '';
    const due_date = dueDateElement?.value || '';

    if (!name) return;

    try {
        const projectData = { name, description, due_date, id: `project_${Date.now()}` };
        
        try {
            const response = await fetch(`${API_URL}/projects`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(projectData)
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    closeModal('addProjectModal');
                    await loadProjects();
                    resetProjectForm();
                    return;
                }
            }
            throw new Error('API request failed');
        } catch (fetchError) {
            console.warn('Project API not available, saving locally:', fetchError.message);
            saveProjectToLocal(projectData);
            closeModal('addProjectModal');
            resetProjectForm();
            showErrorMessage('Project saved locally. Will sync when connected to server.');
        }
        
    } catch (error) {
        handleError(error, 'creating project');
    }
}

function saveProjectToLocal(project) {
    try {
        const saved = localStorage.getItem('khizr_processed_projects');
        let projects = saved ? JSON.parse(saved) : [];
        projects.push(project);
        localStorage.setItem('khizr_processed_projects', JSON.stringify(projects));
        loadProjects();
    } catch (error) {
        console.warn('Failed to save project locally:', error);
    }
}

function resetProjectForm() {
    const elements = ['projectName', 'projectDescription', 'projectDueDate'];
    elements.forEach(id => {
        const element = safeGetElement(id);
        if (element) element.value = '';
    });
}

// Approval handling
async function handleApproval(approvalId, status) {
    try {
        const response = await fetch(`${API_URL}/approvals/${approvalId}`, {
            method: 'PATCH',
            headers: getAuthHeaders(),
            body: JSON.stringify({ status })
        });

        if (response.ok) {
            await loadApprovals();
        } else {
            showErrorMessage(`Failed to ${status} approval. Please try again.`);
        }
    } catch (error) {
        handleError(error, 'handling approval');
    }
}

// AI Note processing
async function processAINote() {
    const noteElement = safeGetElement('aiNote');
    if (!noteElement) return;
    
    const note = noteElement.value.trim();
    if (!note) return;

    const btn = document.querySelector('.ai-send-btn');
    if (!btn) return;

    const originalText = btn.textContent;
    btn.textContent = 'processing...';
    btn.disabled = true;

    try {
        await processChatMessage(note);
        noteElement.value = '';
        await loadTasks();
    } catch (error) {
        console.warn('Failed to process AI note:', error);
    } finally {
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

// Utility functions
function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showView(viewName) {
    // Hide all views
    const viewIds = ['today-view', 'project-view', 'mind-view', 'chat-view', 'emails-view', 'goals-view', 'approvals-view'];
    viewIds.forEach(id => {
        const element = safeGetElement(id);
        if (element) {
            element.style.display = 'none';
            element.classList.remove('active');
        }
    });

    // Show selected view
    if (viewName === 'today') {
        const todayView = safeGetElement('today-view');
        if (todayView) todayView.style.display = 'grid';
    } else {
        const viewElement = safeGetElement(`${viewName}-view`);
        if (viewElement) {
            viewElement.style.display = 'block';
            viewElement.classList.add('active');
        }
    }

    // Update navigation
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(btn => {
        const btnText = btn.textContent.toLowerCase();
        if (btnText.includes(viewName.toLowerCase()) || 
            (viewName === 'chat' && btnText.includes('chat'))) {
            btn.classList.add('active');
        }
    });
}

function setTheme(theme) {
    document.body.className = `theme-${theme}`;
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
    const active = document.querySelector(`.theme-btn.${theme}`);
    if (active) active.classList.add('active');
    localStorage.setItem('theme', theme);
}

function showAddTaskModal() {
    const modal = safeGetElement('addTaskModal');
    if (modal) {
        modal.style.display = 'flex';
        const titleInput = safeGetElement('taskTitle');
        if (titleInput) titleInput.focus();
    }
}

function showAddProjectModal() {
    const modal = safeGetElement('addProjectModal');
    if (modal) {
        modal.style.display = 'flex';
        const nameInput = safeGetElement('projectName');
        if (nameInput) nameInput.focus();
    }
}

function closeModal(modalId) {
    const modal = safeGetElement(modalId);
    if (modal) modal.style.display = 'none';
}

function showMindPage() {
    showView('mind');
}

function saveMindNote() {
    const input = safeGetElement('mindInput');
    if (!input) return;
    
    const content = input.value.trim();
    if (!content) return;

    console.log('Saving mind note:', content);

    const btn = document.querySelector('.mind-save-btn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = 'saved!';
        setTimeout(() => {
            btn.textContent = originalText;
            input.value = '';
        }, 1000);
    }
}

function openProject(projectId) {
    console.log('Opening project:', projectId);
    // TODO: Implement project detail view
}

function updateDateDisplay() {
    const now = new Date();
    const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    };
    safeSetHTML('dateDisplay', now.toLocaleDateString('en-US', options));
}

// Gmail functionality (simplified)
async function connectGmail() {
    const connectBtn = safeGetElement('gmailConnectBtn');
    const refreshBtn = safeGetElement('refreshEmailsBtn');
    const status = safeGetElement('emailStatus');

    if (connectBtn) {
        connectBtn.disabled = true;
        connectBtn.textContent = 'Connecting...';
    }
    if (status) {
        status.textContent = 'Authenticating with Gmail...';
    }

    try {
        const response = await fetch(`${API_URL}/gmail/connect`, {
            method: 'POST',
            headers: getAuthHeaders()
        });

        if (response.ok) {
            if (connectBtn) connectBtn.style.display = 'none';
            if (refreshBtn) refreshBtn.style.display = 'inline-block';
            if (status) status.textContent = 'Connected to Gmail ‚úì';
            await loadEmails();
        } else {
            throw new Error('Failed to connect');
        }
    } catch (error) {
        if (status) status.textContent = 'Connection failed. Please try again.';
        if (connectBtn) {
            connectBtn.disabled = false;
            connectBtn.textContent = 'Connect Gmail';
        }
    }
}

async function loadEmails() {
    const status = safeGetElement('emailStatus');
    if (status) status.textContent = 'Loading emails...';

    try {
        const response = await fetch(`${API_URL}/gmail/messages`, {
            headers: getAuthHeaders()
        });

        if (response.ok) {
            const data = await response.json();
            displayEmails(data.messages || []);
            if (status) status.textContent = `Loaded ${data.messages?.length || 0} emails`;
        } else {
            throw new Error('Failed to load emails');
        }
    } catch (error) {
        if (status) status.textContent = 'Failed to load emails';
        console.error('Email loading error:', error);
    }
}

async function refreshEmails() {
    await loadEmails();
}

function displayEmails(emails) {
    const emailsList = safeGetElement('emailsList');
    if (!emailsList) return;

    if (emails.length === 0) {
        emailsList.innerHTML = '<p>No emails found.</p>';
        return;
    }

    const emailsHTML = emails.map(email => `
        <div class="email-item ${email.unread ? 'unread' : ''}" onclick="openEmail('${email.id}')">
            <div class="email-header">
                <div class="email-from">${escapeHtml(email.from || 'Unknown Sender')}</div>
                <div class="email-date">${formatEmailDate(email.date)}</div>
            </div>
            <div class="email-subject">${escapeHtml(email.subject || 'No Subject')}</div>
            <div class="email-snippet">${escapeHtml(email.snippet || '')}</div>
        </div>
    `).join('');

    emailsList.innerHTML = emailsHTML;
}

function formatEmailDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

function openEmail(emailId) {
    console.log('Opening email:', emailId);
    // TODO: Implement email detail view
}

function logout() {
    localStorage.removeItem('khizr_assistant_gate');
    localStorage.removeItem('khizr_assistant_auth');
    window.location.href = 'index.html';
}

function checkAppAuth() {
    const gateAuth = localStorage.getItem('khizr_assistant_gate');
    if (!gateAuth) {
        window.location.href = 'index.html';
        return;
    }

    try {
        const authData = JSON.parse(gateAuth);
        if (!authData.authenticated || Date.now() > authData.expires) {
            localStorage.removeItem('khizr_assistant_gate');
            window.location.href = 'index.html';
            return;
        }
    } catch (error) {
        localStorage.removeItem('khizr_assistant_gate');
        window.location.href = 'index.html';
        return;
    }
}

// Close modals on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            }
        });
    }
});

// Close modals on outside click
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal-overlay')) {
        event.target.style.display = 'none';
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    checkAppAuth();
    initializeApp();

    const savedTheme = localStorage.getItem('theme') || 'purple';
    setTheme(savedTheme);
});
</script>

</body>
</html>
