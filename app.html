<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khizr Assistant</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

:root {
--primary: #8B5CF6;
--secondary: #EF4444;
--bg: #0A0A0B;
--bg-card: #111115;
--text-primary: #E4E4E7;
--text-secondary: #71717A;
--text-accent: #A855F7;
--border: #27272A;
--border-accent: #3F3F46;
--success: #10B981;
--warning: #F59E0B;
}

.theme-red {
--primary: #EF4444;
--text-accent: #F87171;
}

.theme-purple {
--primary: #8B5CF6;
--text-accent: #A855F7;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'JetBrains Mono', monospace;
background: var(--bg);
color: var(--text-primary);
line-height: 1.6;
font-weight: 400;
min-height: 100vh;
font-size: 14px;
}

.container {
max-width: 900px;
margin: 0 auto;
padding: 40px 20px;
}

/* Header */
.header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 60px;
padding-bottom: 20px;
}

.agent-status {
display: flex;
gap: 8px;
align-items: center;
}

.agent-indicator {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(--success);
}

.agent-indicator.busy {
background: var(--warning);
}

.agent-indicator.offline {
background: var(--text-secondary);
}

.theme-toggle {
display: flex;
gap: 8px;
align-items: center;
}

.theme-btn {
width: 12px;
height: 12px;
border-radius: 2px;
border: none;
cursor: pointer;
transition: all 0.2s ease;
opacity: 0.6;
}

.theme-btn.purple { background: #8B5CF6; }
.theme-btn.red { background: #EF4444; }

.theme-btn:hover {
opacity: 1;
transform: scale(1.1);
}

.theme-btn.active {
opacity: 1;
}

.logout-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 16px;
padding: 4px;
border-radius: 4px;
transition: all 0.2s ease;
margin-left: 16px;
}

.logout-btn:hover {
color: var(--primary);
background: rgba(139, 92, 246, 0.1);
}

/* Navigation */
.nav {
display: flex;
gap: 30px;
margin-bottom: 40px;
font-size: 13px;
font-weight: 500;
}

.nav-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
transition: color 0.2s ease;
position: relative;
padding: 0;
font-family: inherit;
font-size: inherit;
}

.nav-btn:hover {
color: var(--text-primary);
}

.nav-btn.active {
color: var(--primary);
}

.nav-btn.active::after {
content: '';
position: absolute;
bottom: -8px;
left: 0;
width: 100%;
height: 1px;
background: var(--primary);
}

/* Notification Badge */
.notification-badge {
position: relative;
}

.notification-badge::after {
content: attr(data-count);
position: absolute;
top: -8px;
right: -8px;
background: var(--secondary);
color: white;
border-radius: 50%;
width: 16px;
height: 16px;
font-size: 10px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 500;
}

.notification-badge[data-count="0"]::after {
display: none;
}

/* Main Layout */
.today-view {
display: grid;
grid-template-columns: 1.5fr 1fr;
gap: 60px;
}

/* Cards */
.code-card {
padding: 0;
margin-bottom: 48px;
font-size: 13px;
}

.code-card.boxed {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
padding: 24px;
}

.section-header {
color: var(--text-accent);
font-size: 12px;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
}

.add-btn {
background: var(--primary);
border: none;
border-radius: 3px;
padding: 4px 8px;
color: white;
cursor: pointer;
font-size: 10px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.add-btn:hover {
opacity: 0.9;
}

/* Tasks */
.task-list {
list-style: none;
}

.task-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 0;
transition: all 0.2s ease;
cursor: pointer;
}

.task-item:hover {
color: var(--primary);
padding-left: 12px;
}

.task-item.urgent {
border-left: 2px solid var(--secondary);
padding-left: 8px;
}

.task-item.urgent:hover {
padding-left: 16px;
}

.task-title {
font-weight: 400;
flex: 1;
}

.task-priority {
font-size: 10px;
padding: 2px 6px;
border-radius: 3px;
margin-right: 8px;
font-weight: 500;
}

.task-priority.urgent {
background: var(--secondary);
color: white;
}

.task-priority.research {
background: var(--primary);
color: white;
}

.task-actions {
display: flex;
gap: 4px;
opacity: 0;
transition: opacity 0.2s ease;
}

.task-item:hover .task-actions {
opacity: 1;
}

.task-action-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 12px;
padding: 2px;
border-radius: 2px;
transition: all 0.2s ease;
}

.task-action-btn:hover {
color: var(--primary);
background: rgba(139, 92, 246, 0.1);
}

/* Agent Status Cards */
.agent-card {
background: rgba(139, 92, 246, 0.05);
border: 1px solid var(--border);
border-radius: 6px;
padding: 12px;
margin-bottom: 8px;
}

.agent-card.busy {
border-color: var(--warning);
background: rgba(245, 158, 11, 0.05);
}

.agent-card.offline {
opacity: 0.6;
}

.agent-name {
font-size: 11px;
font-weight: 600;
color: var(--primary);
margin-bottom: 4px;
}

.agent-task {
font-size: 10px;
color: var(--text-secondary);
}

/* Chat Interface */
.chat-container {
display: flex;
flex-direction: column;
height: 500px;
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
}

.chat-messages {
flex: 1;
padding: 20px;
overflow-y: auto;
display: flex;
flex-direction: column;
gap: 16px;
}

.chat-message {
display: flex;
flex-direction: column;
max-width: 80%;
}

.chat-message.user {
align-self: flex-end;
}

.chat-message.assistant {
align-self: flex-start;
}

.message-content {
padding: 12px 16px;
border-radius: 8px;
font-size: 13px;
}

.chat-message.user .message-content {
background: var(--primary);
color: white;
}

.chat-message.assistant .message-content {
background: rgba(139, 92, 246, 0.1);
border: 1px solid var(--border);
color: var(--text-primary);
}

.message-time {
font-size: 10px;
color: var(--text-secondary);
margin-top: 4px;
padding: 0 4px;
}

.chat-input-container {
padding: 16px;
border-top: 1px solid var(--border);
display: flex;
gap: 8px;
}

.chat-input {
flex: 1;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 12px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
}

.chat-input:focus {
outline: none;
border-color: var(--primary);
}

.chat-send-btn {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.chat-send-btn:hover {
opacity: 0.9;
}

.chat-send-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Approval Cards */
.approval-item {
background: rgba(245, 158, 11, 0.1);
border: 1px solid var(--warning);
border-radius: 6px;
padding: 16px;
margin-bottom: 12px;
}

.approval-header {
display: flex;
justify-content: between;
align-items: flex-start;
margin-bottom: 8px;
}

.approval-title {
font-weight: 600;
color: var(--warning);
font-size: 13px;
}

.approval-cost {
font-size: 11px;
color: var(--text-secondary);
}

.approval-description {
font-size: 12px;
color: var(--text-primary);
margin-bottom: 12px;
line-height: 1.4;
}

.approval-actions {
display: flex;
gap: 8px;
}

.approve-btn {
background: var(--success);
border: none;
border-radius: 4px;
padding: 6px 12px;
color: white;
cursor: pointer;
font-size: 11px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.reject-btn {
background: var(--secondary);
border: none;
border-radius: 4px;
padding: 6px 12px;
color: white;
cursor: pointer;
font-size: 11px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.approve-btn:hover, .reject-btn:hover {
opacity: 0.9;
}

/* Views */
.project-view, .mind-view, .chat-view, .emails-view, .goals-view, .insights-view, .approvals-view {
display: none;
}

.project-view.active, .mind-view.active, .chat-view.active, .emails-view.active, .goals-view.active, .insights-view.active, .approvals-view.active {
display: block;
}

/* Rest of your existing CSS... */
.project-item {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 6px;
padding: 16px;
margin-bottom: 12px;
cursor: pointer;
transition: all 0.2s ease;
}

.project-item:hover {
border-color: var(--primary);
background: rgba(139, 92, 246, 0.04);
}

.project-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 4px;
}

.project-desc {
color: var(--text-secondary);
font-size: 12px;
}

/* Modal styles and other existing CSS from previous version... */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
}

.modal {
background: var(--bg-card);
border: 1px solid var(--border);
border-radius: 8px;
padding: 24px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
}

.modal-close {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
font-size: 16px;
padding: 4px;
}

.modal-close:hover {
color: var(--primary);
}

.form-group {
margin-bottom: 16px;
}

.form-label {
display: block;
font-size: 12px;
font-weight: 500;
color: var(--text-accent);
margin-bottom: 6px;
}

.form-input, .form-textarea {
width: 100%;
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 12px;
color: var(--text-primary);
font-family: inherit;
font-size: 13px;
}

.form-textarea {
resize: vertical;
min-height: 80px;
}

.form-input:focus, .form-textarea:focus {
outline: none;
border-color: var(--primary);
}

.form-buttons {
display: flex;
gap: 8px;
justify-content: flex-end;
margin-top: 20px;
}

.btn-secondary {
background: transparent;
border: 1px solid var(--border);
border-radius: 4px;
padding: 8px 16px;
color: var(--text-secondary);
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.btn-secondary:hover {
border-color: var(--primary);
color: var(--primary);
}

.btn-primary {
background: var(--primary);
border: none;
border-radius: 4px;
padding: 8px 16px;
color: white;
cursor: pointer;
font-size: 12px;
font-family: inherit;
font-weight: 500;
transition: all 0.2s ease;
}

.btn-primary:hover {
opacity: 0.9;
}

/* Responsive */
@media (max-width: 768px) {
.container {
padding: 20px 16px;
}

.today-view {
grid-template-columns: 1fr;
gap: 32px;
}

.nav {
gap: 20px;
margin-bottom: 32px;
}

.header {
margin-bottom: 40px;
}

.chat-container {
height: 400px;
}

.modal {
width: 95%;
padding: 20px;
}
}
</style>
</head>
<body class="theme-purple">

<div class="container">
<!-- Header with Agent Status -->
<header class="header">
<div class="agent-status" id="agentStatus">
<div class="agent-indicator" id="browserAgent" title="Browser Agent"></div>
<div class="agent-indicator" id="coderAgent" title="Coder Agent"></div>
<div class="agent-indicator" id="pmAgent" title="PM Agent"></div>
<div class="agent-indicator" id="researchAgent" title="Research Agent"></div>
</div>

<div class="header-controls">
<div class="theme-toggle">
<button class="theme-btn purple active" onclick="setTheme('purple')"></button>
<button class="theme-btn red" onclick="setTheme('red')"></button>
</div>
<button class="logout-btn" onclick="logout()" title="Logout">🚪</button>
</div>
</header>

<!-- Navigation -->
<nav class="nav">
<button class="nav-btn active" onclick="showView('today')">today</button>
<button class="nav-btn" onclick="showView('projects')">projects</button>
<button class="nav-btn" onclick="showView('goals')">goals</button>
<button class="nav-btn notification-badge" data-count="0" onclick="showView('approvals')" id="approvalsNavBtn">approvals</button>
<button class="nav-btn" onclick="showView('chat')">ai chat</button>
<button class="nav-btn" onclick="showView('emails')">emails</button>
</nav>

<!-- Today View -->
<div id="today-view" class="today-view">
<div class="main-content">
<!-- Date Display -->
<div class="code-card">
<div class="section-header">today</div>
<div class="date-display" id="dateDisplay"></div>
</div>

<!-- Dynamic Tasks -->
<div class="code-card" id="tasksContainer">
<div class="section-header">
tasks
<button class="add-btn" onclick="showAddTaskModal()">+ add</button>
</div>
<ul class="task-list" id="tasksList">
<!-- Tasks will be loaded dynamically -->
</ul>
</div>

<!-- AI Input -->
<div class="code-card">
<div class="section-header">quick process</div>
<div class="ai-input-container">
<div class="ai-prompt">tell me what's on your mind</div>
<textarea
class="ai-textarea"
placeholder="? research question | zz task | !! urgent | og preserve note"
id="aiNote"
></textarea>
<button class="ai-send-btn" onclick="processAINote()">run</button>
</div>
</div>
</div>

<div class="sidebar">
<!-- Agent Status -->
<div class="code-card">
<div class="section-header">agents</div>
<div id="agentCards">
<!-- Agent status cards will be loaded here -->
</div>
</div>

<!-- Time-bound Events -->
<div class="code-card">
<div class="section-header">timebound</div>
<ul class="time-list" id="timeEvents">
<!-- Calendar events will be loaded here -->
</ul>
</div>

<!-- Quick Actions -->
<button class="mind-btn" onclick="showMindPage()">
 on my mind
</button>
</div>
</div>

<!-- Other Views -->
<div id="project-view" class="project-view">
<div class="code-card boxed">
<div class="section-header">
projects
<button class="add-btn" onclick="showAddProjectModal()">+ add</button>
</div>
<div class="project-list" id="projectList">
<!-- Projects will be loaded dynamically -->
</div>
</div>
</div>

<!-- Approvals View -->
<div id="approvals-view" class="approvals-view">
<div class="code-card boxed">
<div class="section-header">approvals needed</div>
<div id="approvalsList">
<!-- Pending approvals will be loaded here -->
</div>
</div>
</div>

<div id="goals-view" class="goals-view">
<div class="code-card boxed">
<div class="section-header">goals</div>
<p>Goals tracking coming soon...</p>
</div>
</div>

<div id="mind-view" class="mind-view">
<div class="code-card boxed">
<div class="section-header">on my mind</div>
<textarea
id="mindInput"
class="mind-textarea"
placeholder="Share your thoughts, ideas, concerns..."
></textarea>
<button class="mind-save-btn" onclick="saveMindNote()">save thought</button>
</div>
</div>

<!-- AI Chat View -->
<div id="chat-view" class="chat-view">
<div class="code-card boxed">
<div class="section-header">ai chat</div>
<div class="chat-container">
<div class="chat-messages" id="chatMessages">
<!-- Chat history will be loaded here -->
</div>
<div class="chat-input-container">
  <!-- Add AI model selector -->
  <div class="ai-model-selector" style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
    <label for="aiModel" style="font-size: 11px; color: var(--text-secondary);">AI Model:</label>
    <select id="aiModel" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); font-size: 12px;">
      <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Best)</option>
      <option value="anthropic/claude-3-haiku">Claude 3 Haiku (Fast)</option>
      <option value="openai/gpt-4o">GPT-4o (Latest)</option>
      <option value="openai/gpt-4o-mini">GPT-4o Mini (Cheap)</option>
      <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
      <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
      <option value="mistralai/mistral-large">Mistral Large</option>
    </select>
  </div>

<input
type="text"
class="chat-input"
id="chatInput"
placeholder="Type your message or use prefixes: ? zz og !!"
onkeypress="handleChatKeyPress(event)"
>
<button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
</div>
</div>
</div>
</div>

<!-- Email View -->
<div id="emails-view" class="emails-view">
<div class="code-card boxed">
<div class="section-header">emails</div>
<div class="emails-controls" style="margin-bottom: 20px;">
<button class="btn-primary" onclick="connectGmail()" id="gmailConnectBtn">
Connect Gmail
</button>
<button class="btn-secondary" onclick="refreshEmails()" id="refreshEmailsBtn" style="display:none;">
Refresh
</button>
<span id="emailStatus" style="margin-left: 12px; font-size: 11px; color: var(--text-secondary);"></span>
</div>
<div class="emails-list" id="emailsList">
<p>Click "Connect Gmail" to start managing your emails...</p>
</div>
</div>
</div>

</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal-overlay" style="display: none;">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Add New Task</h3>
<button class="modal-close" onclick="closeModal('addTaskModal')">×</button>
</div>
<form onsubmit="submitTask(event)">
<div class="form-group">
<label class="form-label">Task Title</label>
<input type="text" class="form-input" id="taskTitle" required>
</div>
<div class="form-group">
<label class="form-label">Priority</label>
<select class="form-input" id="taskPriority">
<option value="normal">Normal</option>
<option value="urgent">Urgent</option>
<option value="low">Low</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Assign To</label>
<select class="form-input" id="taskAssignTo">
<option value="human">Me</option>
<option value="browser_agent">Browser Agent</option>
<option value="coder_agent">Coder Agent</option>
<option value="pm_agent">PM Agent</option>
<option value="researcher_agent">Research Agent</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Description (optional)</label>
<textarea class="form-textarea" id="taskDescription" placeholder="Additional details..."></textarea>
</div>
<div class="form-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
<button type="submit" class="btn-primary">Add Task</button>
</div>
</form>
</div>
</div>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal-overlay" style="display: none;">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Add New Project</h3>
<button class="modal-close" onclick="closeModal('addProjectModal')">×</button>
</div>
<form onsubmit="submitProject(event)">
<div class="form-group">
<label class="form-label">Project Name</label>
<input type="text" class="form-input" id="projectName" required>
</div>
<div class="form-group">
<label class="form-label">Description</label>
<textarea class="form-textarea" id="projectDescription" placeholder="What is this project about?"></textarea>
</div>
<div class="form-group">
<label class="form-label">Due Date (optional)</label>
<input type="date" class="form-input" id="projectDueDate">
</div>
<div class="form-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('addProjectModal')">Cancel</button>
<button type="submit" class="btn-primary">Add Project</button>
</div>
</form>
</div>
</div>

<script>
const API_URL = "https://khizr-assistant-api.onrender.com";

// Global state
let agents = [];
let currentUser = null;
let notifications = 0;
let pendingApprovals = [];

// Available AI models for display
const AVAILABLE_MODELS = {
  'anthropic/claude-3.5-sonnet': 'Claude 3.5 Sonnet',
  'anthropic/claude-3-haiku': 'Claude 3 Haiku',
  'openai/gpt-4o': 'GPT-4o',
  'openai/gpt-4o-mini': 'GPT-4o Mini',
  'google/gemini-pro-1.5': 'Gemini Pro 1.5',
  'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
  'mistralai/mistral-large': 'Mistral Large'
};

// Authentication helper
function getAuthHeaders() {
const token = localStorage.getItem('khizr_assistant_auth');
return {
'Authorization': `Bearer ${token}`,
'Content-Type': 'application/json'
};
}

// Initialize application
async function initializeApp() {
try {
await loadAgentStatus();
await loadTasks();
await loadProjects();
await loadApprovals();
await loadChatHistory();
updateDateDisplay();
setInterval(loadAgentStatus, 30000); // Update agent status every 30 seconds
setInterval(loadApprovals, 60000); // Check for approvals every minute
} catch (error) {
console.error('Failed to initialize app:', error);
}
}

// Load agent status
async function loadAgentStatus() {
try {
const response = await fetch(`${API_URL}/api/agents`, {
headers: getAuthHeaders()
});
const data = await response.json();

if (data.success) {
agents = data.agents;
updateAgentIndicators();
updateAgentCards();
}
} catch (error) {
console.error('Failed to load agent status:', error);
}
}

function updateAgentIndicators() {
agents.forEach(agent => {
const indicator = document.getElementById(agent.name.replace('_', '') + 'Agent');
if (indicator) {
indicator.className = `agent-indicator ${agent.status}`;
}
});
}

function updateAgentCards() {
const agentCards = document.getElementById('agentCards');
if (!agentCards) return;

const cardsHTML = agents.map(agent => `
<div class="agent-card ${agent.status}">
<div class="agent-name">${agent.display_name}</div>
<div class="agent-task">${agent.status === 'busy' ? 'Working on task...' : agent.status}</div>
</div>
`).join('');

agentCards.innerHTML = cardsHTML;
}

// Load tasks
async function loadTasks() {
try {
const response = await fetch(`${API_URL}/api/tasks?limit=10`, {
headers: getAuthHeaders()
});
const data = await response.json();

if (data.success) {
displayTasks(data.tasks);
}
} catch (error) {
console.error('Failed to load tasks:', error);
}
}

function displayTasks(tasks) {
const tasksList = document.getElementById('tasksList');
if (!tasksList) return;

if (tasks.length === 0) {
tasksList.innerHTML = '<li style="color: var(--text-secondary); font-style: italic;">No tasks yet. Create one above!</li>';
return;
}

const tasksHTML = tasks.map(task => `
<li class="task-item ${task.priority === 'urgent' ? 'urgent' : ''}">
<span class="task-title">${task.title}</span>
${task.priority === 'urgent' ? '<span class="task-priority urgent">URGENT</span>' : ''}
${task.task_type === 'agent' ? '<span class="task-priority research">AGENT</span>' : ''}
<div class="task-actions">
<button class="task-action-btn" onclick="completeTask('${task.id}')" title="Complete">✓</button>
<button class="task-action-btn" onclick="deleteTask('${task.id}')" title="Delete">🗑️</button>
</div>
</li>
`).join('');

tasksList.innerHTML = tasksHTML;
}

// Load projects
async function loadProjects() {
try {
const response = await fetch(`${API_URL}/api/projects`, {
headers: getAuthHeaders()
});
const data = await response.json();

if (data.success) {
displayProjects(data.projects);
}
} catch (error) {
console.error('Failed to load projects:', error);
}
}

function displayProjects(projects) {
const projectList = document.getElementById('projectList');
if (!projectList) return;

if (projects.length === 0) {
projectList.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No projects yet. Create one above!</p>';
return;
}

const projectsHTML = projects.map(project => `
<div class="project-item" onclick="openProject('${project.id}')">
<div class="project-title">${project.name}</div>
<div class="project-desc">${project.description || 'No description'}</div>
</div>
`).join('');

projectList.innerHTML = projectsHTML;
}

// Load pending approvals
async function loadApprovals() {
try {
const response = await fetch(`${API_URL}/api/approvals/pending`, {
headers: getAuthHeaders()
});
const data = await response.json();

if (data.success) {
pendingApprovals = data.approvals;
displayApprovals(data.approvals);
updateApprovalsBadge(data.approvals.length);
}
} catch (error) {
console.error('Failed to load approvals:', error);
}
}

function displayApprovals(approvals) {
const approvalsList = document.getElementById('approvalsList');
if (!approvalsList) return;

if (approvals.length === 0) {
approvalsList.innerHTML = '<p style="color: var(--text-secondary);">No approvals needed right now.</p>';
return;
}

const approvalsHTML = approvals.map(approval => `
<div class="approval-item">
<div class="approval-header">
<div class="approval-title">${approval.title}</div>
${approval.estimated_cost ? `<div class="approval-cost">${approval.estimated_cost}</div>` : ''}
</div>
<div class="approval-description">${approval.description}</div>
<div class="approval-actions">
<button class="approve-btn" onclick="handleApproval('${approval.id}', 'approved')">Approve</button>
<button class="reject-btn" onclick="handleApproval('${approval.id}', 'rejected')">Reject</button>
</div>
</div>
`).join('');

approvalsList.innerHTML = approvalsHTML;
}

function updateApprovalsBadge(count) {
const badge = document.getElementById('approvalsNavBtn');
if (badge) {
badge.setAttribute('data-count', count);
}
}

// Chat functionality
async function loadChatHistory() {
try {
const response = await fetch(`${API_URL}/api/chat/history`, {
headers: getAuthHeaders()
});
const data = await response.json();

if (data.success && data.chat_history.length > 0) {
const messagesContainer = document.getElementById('chatMessages');
messagesContainer.innerHTML = ''; // Clear existing messages
data.chat_history.forEach(msg => {
addChatMessage('user', msg.description);
// Add a simple response for historical messages
addChatMessage('assistant', 'Message processed and stored in your knowledge base.');
});
} else {
// Add welcome message if no history
addChatMessage('assistant', 'Hey! I\'m your AI assistant. You can ask me anything or use our prefix system: <strong>?</strong> for research, <strong>zz</strong> for tasks, <strong>!!</strong> for urgent items.');
}
} catch (error) {
console.error('Failed to load chat history:', error);
}
}

function sendChatMessage() {
const input = document.getElementById('chatInput');
const message = input.value.trim();
if (!message) return;

addChatMessage('user', message);
input.value = '';

const sendBtn = document.getElementById('chatSendBtn');
sendBtn.disabled = true;
sendBtn.textContent = 'Thinking...';

processChatMessage(message);
}

async function processChatMessage(message) {
  try {
    const aiModel = document.getElementById('aiModel').value;

    const response = await fetch(`${API_URL}/api/chat/process`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ message, model: aiModel })
    });

    const data = await response.json();

    if (data.success) {
      addChatMessage('assistant', data.message);

      // Show which model was used
      if (data.model_used) {
        const modelName = AVAILABLE_MODELS[data.model_used] || data.model_used;
        addChatMessage('system', `🤖 ${modelName}`);
      }

      // Handle task/project creation based on message type
      if (data.type === 'task_created' || data.type === 'urgent_created') {
        await loadTasks();
        await loadApprovals();
      } else if (data.type === 'project_related') {
        await loadProjects();
      }
    } else {
      addChatMessage('assistant', data.message);

      // Handle specific error types
      if (data.error_type === 'rate_limit') {
        addChatMessage('system', '⚠️ Rate limit reached. Please wait before sending more messages.');
      } else if (data.error_type === 'insufficient_credits') {
        addChatMessage('system', '💰 OpenRouter credits exhausted. Please add more credits.');
      }
    }
  } catch (error) {
    console.error('Chat processing error:', error);
    addChatMessage('assistant', 'Connection error. Please check your internet and try again.');
  } finally {
    const sendBtn = document.getElementById('chatSendBtn');
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
  }
}

function addChatMessage(sender, content) {
const messagesContainer = document.getElementById('chatMessages');
const messageDiv = document.createElement('div');
messageDiv.className = `chat-message ${sender}`;

const now = new Date();
const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

messageDiv.innerHTML = `
<div class="message-content">${content}</div>
<div class="message-time">${timeString}</div>
`;

messagesContainer.appendChild(messageDiv);
messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function handleChatKeyPress(event) {
if (event.key === 'Enter' && !event.shiftKey) {
event.preventDefault();
sendChatMessage();
}
}

// Task management
async function submitTask(event) {
event.preventDefault();
const title = document.getElementById('taskTitle').value.trim();
const priority = document.getElementById('taskPriority').value;
const assigned_to = document.getElementById('taskAssignTo').value;
const description = document.getElementById('taskDescription').value.trim();

if (!title) return;

try {
const response = await fetch(`${API_URL}/api/tasks`, {
method: 'POST',
headers: getAuthHeaders(),
body: JSON.stringify({
title,
priority,
assigned_to: assigned_to === 'human' ? null : assigned_to,
task_type: assigned_to === 'human' ? 'manual' : 'agent',
description
})
});

const data = await response.json();

if (data.success) {
closeModal('addTaskModal');
await loadTasks();

// Reset form
document.getElementById('taskTitle').value = '';
document.getElementById('taskDescription').value = '';
document.getElementById('taskPriority').value = 'normal';
document.getElementById('taskAssignTo').value = 'human';
}
} catch (error) {
console.error('Failed to create task:', error);
}
}

async function completeTask(taskId) {
try {
const response = await fetch(`${API_URL}/api/tasks/${taskId}/status`, {
method: 'PATCH',
headers: getAuthHeaders(),
body: JSON.stringify({ status: 'completed' })
});

if (response.ok) {
await loadTasks();
}
} catch (error) {
console.error('Failed to complete task:', error);
}
}

async function deleteTask(taskId) {
// For now, we'll mark as cancelled instead of deleting
await completeTask(taskId);
}

// Project management
async function submitProject(event) {
event.preventDefault();
const name = document.getElementById('projectName').value.trim();
const description = document.getElementById('projectDescription').value.trim();
const due_date = document.getElementById('projectDueDate').value;

if (!name) return;

try {
const response = await fetch(`${API_URL}/api/projects`, {
method: 'POST',
headers: getAuthHeaders(),
body: JSON.stringify({ name, description, due_date })
});

const data = await response.json();

if (data.success) {
closeModal('addProjectModal');
await loadProjects();

// Reset form
document.getElementById('projectName').value = '';
document.getElementById('projectDescription').value = '';
document.getElementById('projectDueDate').value = '';
}
} catch (error) {
console.error('Failed to create project:', error);
}
}

// Approval handling
async function handleApproval(approvalId, status) {
try {
const response = await fetch(`${API_URL}/api/approvals/${approvalId}`, {
method: 'PATCH',
headers: getAuthHeaders(),
body: JSON.stringify({ status })
});

if (response.ok) {
await loadApprovals();
}
} catch (error) {
console.error('Failed to handle approval:', error);
}
}

// AI Note processing (quick processing)
async function processAINote() {
const note = document.getElementById('aiNote')?.value || '';
if (!note.trim()) return;

const btn = document.querySelector('.ai-send-btn');
if (!btn) return;

const originalText = btn.textContent;
btn.textContent = 'processing...';
btn.disabled = true;

try {
await processChatMessage(note);
document.getElementById('aiNote').value = '';
await loadTasks(); // Refresh tasks in case new ones were created
} catch (error) {
console.error('Failed to process AI note:', error);
} finally {
setTimeout(() => {
btn.textContent = originalText;
btn.disabled = false;
}, 1000);
}
}

// UI Helper functions
function showView(viewName) {
document.querySelectorAll('[id$="-view"]').forEach(view => {
view.style.display = 'none';
view.classList.remove('active');
});

if (viewName === 'today') {
document.getElementById('today-view').style.display = 'grid';
} else {
const viewElement = document.getElementById(`${viewName}-view`);
if (viewElement) {
viewElement.style.display = 'block';
viewElement.classList.add('active');
}
}

document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
document.querySelectorAll('.nav-btn').forEach(btn => {
if (btn.textContent.toLowerCase().includes(viewName.toLowerCase()) || 
    (viewName === 'chat' && btn.textContent.toLowerCase().includes('chat'))) {
btn.classList.add('active');
}
});
}

function setTheme(theme) {
document.body.className = `theme-${theme}`;
document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
const active = document.querySelector(`.theme-btn.${theme}`);
if (active) active.classList.add('active');
localStorage.setItem('theme', theme);
}

function showAddTaskModal() {
document.getElementById('addTaskModal').style.display = 'flex';
document.getElementById('taskTitle').focus();
}

function showAddProjectModal() {
document.getElementById('addProjectModal').style.display = 'flex';
document.getElementById('projectName').focus();
}

function closeModal(modalId) {
document.getElementById(modalId).style.display = 'none';
}

function showMindPage() {
showView('mind');
}

function saveMindNote() {
const input = document.getElementById('mindInput');
const content = input.value.trim();
if (!content) return;

console.log('Saving mind note:', content);

const btn = document.querySelector('.mind-save-btn');
const originalText = btn.textContent;
btn.textContent = 'saved!';
setTimeout(() => {
btn.textContent = originalText;
input.value = '';
}, 1000);
}

function openProject(projectId) {
console.log('Opening project:', projectId);
// TODO: Implement project detail view
}

function updateDateDisplay() {
const dateDisplay = document.getElementById('dateDisplay');
if (dateDisplay) {
const now = new Date();
const options = {
weekday: 'long',
year: 'numeric',
month: 'long',
day: 'numeric'
};
dateDisplay.textContent = now.toLocaleDateString('en-US', options);
}
}

// Gmail functionality (existing)
async function connectGmail() {
const connectBtn = document.getElementById('gmailConnectBtn');
const refreshBtn = document.getElementById('refreshEmailsBtn');
const status = document.getElementById('emailStatus');

connectBtn.disabled = true;
connectBtn.textContent = 'Connecting...';
status.textContent = 'Authenticating with Gmail...';

try {
const response = await fetch(`${API_URL}/api/gmail/connect`, {
method: 'POST',
headers: getAuthHeaders()
});

if (response.ok) {
connectBtn.style.display = 'none';
refreshBtn.style.display = 'inline-block';
status.textContent = 'Connected to Gmail ✓';
await loadEmails();
} else {
throw new Error('Failed to connect');
}
} catch (error) {
status.textContent = 'Connection failed. Please try again.';
connectBtn.disabled = false;
connectBtn.textContent = 'Connect Gmail';
}
}

async function loadEmails() {
const status = document.getElementById('emailStatus');
status.textContent = 'Loading emails...';

try {
const response = await fetch(`${API_URL}/api/gmail/messages`, {
headers: getAuthHeaders()
});

if (response.ok) {
const data = await response.json();
displayEmails(data.messages || []);
status.textContent = `Loaded ${data.messages?.length || 0} emails`;
} else {
throw new Error('Failed to load emails');
}
} catch (error) {
status.textContent = 'Failed to load emails';
console.error('Email loading error:', error);
}
}

async function refreshEmails() {
await loadEmails();
}

function displayEmails(emails) {
const emailsList = document.getElementById('emailsList');

if (emails.length === 0) {
emailsList.innerHTML = '<p>No emails found.</p>';
return;
}

const emailsHTML = emails.map(email => `
<div class="email-item ${email.unread ? 'unread' : ''}" onclick="openEmail('${email.id}')">
<div class="email-header">
<div class="email-from">${email.from || 'Unknown Sender'}</div>
<div class="email-date">${formatEmailDate(email.date)}</div>
</div>
<div class="email-subject">${email.subject || 'No Subject'}</div>
<div class="email-snippet">${email.snippet || ''}</div>
</div>
`).join('');

emailsList.innerHTML = emailsHTML;
}

function formatEmailDate(dateString) {
if (!dateString) return '';
const date = new Date(dateString);
const now = new Date();
const diffTime = Math.abs(now - date);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (diffDays === 1) return 'Yesterday';
if (diffDays < 7) return `${diffDays} days ago`;
return date.toLocaleDateString();
}

function openEmail(emailId) {
console.log('Opening email:', emailId);
// TODO: Implement email detail view
}

function logout() {
localStorage.removeItem('khizr_assistant_gate');
localStorage.removeItem('khizr_assistant_auth');
window.location.href = 'index.html';
}

function checkAppAuth() {
const gateAuth = localStorage.getItem('khizr_assistant_gate');
if (!gateAuth) {
window.location.href = 'index.html';
return;
}

try {
const authData = JSON.parse(gateAuth);
if (!authData.authenticated || Date.now() > authData.expires) {
localStorage.removeItem('khizr_assistant_gate');
window.location.href = 'index.html';
return;
}
} catch (error) {
localStorage.removeItem('khizr_assistant_gate');
window.location.href = 'index.html';
return;
}
}

// Close modals on escape key
document.addEventListener('keydown', function(event) {
if (event.key === 'Escape') {
const modals = document.querySelectorAll('.modal-overlay');
modals.forEach(modal => {
if (modal.style.display === 'flex') {
modal.style.display = 'none';
}
});
}
});

// Close modals on outside click
document.addEventListener('click', function(event) {
if (event.target.classList.contains('modal-overlay')) {
event.target.style.display = 'none';
}
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
checkAppAuth();
initializeApp();

const savedTheme = localStorage.getItem('theme') || 'purple';
setTheme(savedTheme);
});

</script>

</body>
</html>